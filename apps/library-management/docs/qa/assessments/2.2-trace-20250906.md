# Requirements Traceability Matrix

## Story: 2.2 - Ultra-Simple Add New Books

### Coverage Summary

- **Total Requirements**: 11 acceptance criteria
- **Fully Covered**: 8 (73%)
- **Partially Covered**: 3 (27%)
- **Not Covered**: 0 (0%)
- **Critical Gaps**: 2 high-priority integration gaps

### Requirement Mappings

#### AC1: Book search combobox allows searching existing book editions by title with real-time results

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `use-book-search.test.tsx::should search books when search term is 3+ characters`
  - Given: User has entered 3+ character search term
  - When: useBookSearch hook is called with enabled=true
  - Then: API call made and search results returned

- **Unit Test**: `use-book-search.test.tsx::should return empty state when search term is too short`
  - Given: User has entered less than 3 characters
  - When: Search hook is called
  - Then: No API call made, empty results returned

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC2: Should search for existing books`
  - Given: User on add book page
  - When: Typing "The Great Gatsby" in search input
  - Then: Search results appear or "no books found" message shown

#### AC2: If book edition exists, user can select it and skip to step 4 (add copies)

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC2: Should search for existing books`
  - Given: User searches for existing book
  - When: Search results are displayed
  - Then: Results shown with selection capability
  - **Gap**: Missing test for "skip to step 4" functionality

#### AC3: If book edition not found, "+ Add book edition" button expands inline edition form

**Coverage: FULL**

Given-When-Then Mappings:

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC3: Should create new book edition with progressive form`
  - Given: User searches for non-existent book
  - When: No results found and "Add New Book" button clicked
  - Then: Navigation to edition form (step 2) with author selection

#### AC4: Edition form includes author search combobox with real-time author suggestions

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test**: `book-creation-flow.test.ts::should complete the full book creation workflow`
  - Given: Author exists in database
  - When: Author search API called
  - Then: Author found and returned in search results

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC3: Should create new book edition with progressive form`
  - Given: User on edition form
  - When: Typing in author search field
  - Then: Real-time author suggestions appear

#### AC5: If author exists, user selects from list; if not found, "+ Add author" opens modal

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test**: `book-creation-flow.test.ts::should complete the full book creation workflow`
  - Given: Author search returns no results
  - When: User creates new author
  - Then: Author successfully created and available for selection

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC3: Should create new book edition with progressive form`
  - Given: No author results found
  - When: "Add New Author" button clicked
  - Then: Modal opens for author creation

#### AC6: Author modal allows creating new author with name and optional biography

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test**: `book-creation-flow.test.ts::should complete the full book creation workflow`
  - Given: User provides author name and biography
  - When: Author creation API called
  - Then: Author created with correct data and canonical name

- **Integration Test**: `book-creation-flow.test.ts::should handle missing optional fields`
  - Given: User provides only author name (no biography)
  - When: Author creation API called
  - Then: Author created with name, biography set to null

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC3: Should create new book edition with progressive form`
  - Given: User in author modal
  - When: Filling name and biography fields and submitting
  - Then: Author created and modal returns to edition form

#### AC7: After selecting/creating author, user completes edition details (title, year, publisher, ISBN)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `use-book-management.test.tsx::should create book edition successfully`
  - Given: Valid edition form data with author_id
  - When: useCreateBookEdition mutation called
  - Then: Book edition created and query cache invalidated

- **Integration Test**: `book-creation-flow.test.ts::should complete the full book creation workflow`
  - Given: Author exists and edition data provided
  - When: Edition creation API called
  - Then: Edition created with proper author linking and metadata

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC3: Should create new book edition with progressive form`
  - Given: Author selected on edition form
  - When: User fills title, subtitle, publisher, year, ISBN
  - Then: Edition form submits and navigates to copies step

#### AC8: Final step: user creates book copies with library-specific details (copy numbers, total copies, shelf location)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `use-book-management.test.tsx::should create book copies successfully`
  - Given: Edition ID, library ID, and copy data
  - When: useCreateBookCopies mutation called
  - Then: Copies created with proper library association and query invalidation

- **Integration Test**: `book-creation-flow.test.ts::should complete the full book creation workflow`
  - Given: Valid edition and library context
  - When: Copy creation API called with location and condition data
  - Then: Copies created with sequential numbering and proper metadata

- **Integration Test**: `book-creation-flow.test.ts::should handle sequential copy numbering`
  - Given: Existing copies for edition in library
  - When: New copies created
  - Then: Copy numbers continue sequentially (001, 002, 003, etc.)

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC4: Should create book copies with validation`
  - Given: User on copies form
  - When: Setting copy count and location details
  - Then: Copies created with library-specific details

#### AC9: All new books automatically set to "available" status with immediate list visibility

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test**: `book-creation-flow.test.ts::should complete the full book creation workflow`
  - Given: New book copies being created
  - When: Copy creation completes
  - Then: All copies have availability.status = "available" and current_borrower_id = null

- **Unit Test**: `use-book-management.test.tsx::should invalidate library queries on success`
  - Given: Book copy creation successful
  - When: Mutation completes
  - Then: Library books cache invalidated for immediate visibility

#### AC10: Progressive form validation ensures required fields at each step

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Integration Test**: `book-creation-flow.test.ts::should validate required fields`
  - Given: Invalid form data (empty name, title)
  - When: API creation functions called
  - Then: Validation errors thrown for required fields

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC7: Should validate form inputs correctly`
  - Given: User on search step
  - When: Entering less than 3 characters
  - Then: Validation message displayed

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC4: Should create book copies with validation`
  - Given: User on copies form
  - When: Setting invalid copy count (0)
  - Then: Validation error displayed
  - **Gap**: Missing comprehensive client-side validation tests for all form steps

#### AC11: Success notification with option to "Add Another Book" resets to step 1

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **E2E Test**: `story-2.2-add-book-workflow.spec.ts::AC5: Should show success confirmation and navigate`
  - Given: Book creation workflow completed
  - When: Success page displayed
  - Then: Success message and navigation options available
  - **Gap**: Missing test for "Add Another Book" workflow reset functionality

### Critical Gaps Analysis

#### Gap 1: Skip-to-Copies Flow (AC2)
- **Location**: AC2 implementation
- **Risk**: High - Core workflow optimization not fully tested
- **Issue**: E2E test verifies search results but doesn't test the "skip to step 4" logic when selecting existing book
- **Suggested Test**:
  ```typescript
  test("should skip to copies when existing book selected", async ({ page }) => {
    // Given: Existing book found in search results
    // When: User selects existing book from search results  
    // Then: Workflow jumps directly to step 4 (add copies), skipping edition form
  });
  ```

#### Gap 2: Workflow Reset Functionality (AC11)
- **Location**: Success flow implementation  
- **Risk**: Medium - User experience feature not validated
- **Issue**: Test verifies success page but doesn't test "Add Another Book" button that should reset to step 1
- **Suggested Test**:
  ```typescript
  test("should reset workflow when 'Add Another Book' clicked", async ({ page }) => {
    // Given: Success page displayed after book creation
    // When: "Add Another Book" button clicked
    // Then: Workflow resets to step 1 (search) with clean state
  });
  ```

#### Gap 3: Comprehensive Client-Side Validation (AC10)
- **Location**: Form validation across all workflow steps
- **Risk**: Medium - User experience and data quality
- **Issue**: Only partial validation testing - missing comprehensive tests for all form fields across all steps
- **Suggested Tests**:
  - Edition form field validation (title, language, ISBN format)
  - Author form validation (name length, biography limits)
  - Copies form validation (copy counts, location field limits)

### Test Design Recommendations

#### 1. Integration Test Enhancements
Add comprehensive workflow integration tests:
```typescript
describe("Complete Progressive Workflow Integration", () => {
  test("should handle existing book selection and skip to copies");
  test("should maintain form state when navigating between steps");
  test("should handle network failures gracefully at each step");
});
```

#### 2. Component Unit Tests
Add missing component-level tests:
```typescript
describe("AddBookWorkflow Component", () => {
  test("should manage step transitions correctly");
  test("should preserve data when moving between steps");
  test("should handle step validation before progression");
});
```

#### 3. API Error Handling Tests
Enhance error scenario coverage:
```typescript
describe("API Error Scenarios", () => {
  test("should handle author creation conflicts");
  test("should handle ISBN validation errors");
  test("should handle library permission errors");
});
```

### Risk Assessment

- **High Risk**: AC2 skip-to-copies flow - Critical UX optimization not fully validated
- **Medium Risk**: AC11 workflow reset, AC10 comprehensive validation - UX features partially tested
- **Low Risk**: AC1, AC3-AC9 - Core functionality has comprehensive unit, integration, and E2E coverage

### Performance Considerations

Current test suite includes:
- Query cache invalidation testing (immediate visibility)
- Search debouncing validation (300ms delay)
- Batch copy creation testing (up to 99 copies)
- Sequential numbering performance (continuing from existing copies)

### Accessibility & Mobile Coverage

E2E tests include:
- Mobile viewport testing (375x667)
- Keyboard navigation (form focus management)
- Screen reader compatibility (ARIA labels, semantic HTML)

### Test Data Strategy

Integration tests use:
- Self-contained test data with cleanup
- Realistic book metadata (titles, ISBNs, authors)
- Library context simulation
- Edge cases (minimal required fields, boundary values)