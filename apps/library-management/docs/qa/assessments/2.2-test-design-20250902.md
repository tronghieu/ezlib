# Test Design: Story 2.2 - Ultra-Simple Add New Books

**Date**: 2025-09-02  
**Designer**: Quinn (Test Architect)  
**Story**: 2.2 - Ultra-Simple Add New Books  

## Test Strategy Overview

- **Total test scenarios**: 32
- **Unit tests**: 14 (44%)
- **Integration tests**: 13 (41%)
- **E2E tests**: 5 (15%)
- **Priority distribution**: P0: 15, P1: 11, P2: 6

**Risk-Based Focus**: 75% of test effort targets high-risk areas (database transactions, duplicate detection, data integrity)

## Test Scenarios by Acceptance Criteria

### AC1: Simple add book form with required/optional fields

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-001 | Unit        | P0       | Form validation schema - required fields | Critical validation logic        |
| 2.2-UNIT-002 | Unit        | P1       | Form validation schema - optional fields | Business rules validation       |
| 2.2-UNIT-003 | Unit        | P1       | ISBN format validation                   | Complex regex logic              |
| 2.2-INT-001  | Integration | P0       | Form submission with valid data         | Component interaction            |
| 2.2-INT-002  | Integration | P1       | Form error handling and display         | Error boundary integration       |
| 2.2-E2E-001  | E2E         | P1       | User completes basic book form          | Critical user journey            |

### AC2: Optional ISBN lookup integration with crawler service

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-004 | Unit        | P2       | ISBN lookup service client              | Service integration logic        |
| 2.2-INT-003  | Integration | P2       | ISBN enrichment successful response     | External service integration     |
| 2.2-INT-004  | Integration | P1       | ISBN enrichment graceful failure       | Fallback behavior critical       |
| 2.2-E2E-002  | E2E         | P2       | User uses ISBN lookup successfully     | Feature workflow validation     |

### AC3: Manual entry fallback for books without ISBNs

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-005 | Unit        | P1       | Form accepts empty ISBN field          | Business logic validation       |
| 2.2-INT-005  | Integration | P1       | Create book without ISBN               | Database integration             |
| 2.2-E2E-003  | E2E         | P1       | User creates book without ISBN         | Alternative user path            |

### AC4: Duplicate detection prevents same title/author combination

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-006 | Unit        | P0       | Author name normalization              | Critical duplicate logic         |
| 2.2-UNIT-007 | Unit        | P0       | Title comparison logic                 | Critical duplicate logic         |
| 2.2-INT-006  | Integration | P0       | Duplicate detection query              | **PERF-001 risk mitigation**    |
| 2.2-INT-007  | Integration | P0       | Duplicate prevention within library    | **DATA-001 risk mitigation**    |
| 2.2-INT-008  | Integration | P1       | Allow duplicates across libraries      | Multi-tenant boundary            |
| 2.2-E2E-004  | E2E         | P1       | User sees duplicate warning dialog     | User experience validation      |

### AC5: All new books automatically set to "available" status

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-008 | Unit        | P1       | Book copy status initialization        | Business logic validation       |
| 2.2-INT-009  | Integration | P0       | Database sets availability correctly   | Data integrity critical          |

### AC6: Success notification with "Add Another Book" option

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-009 | Unit        | P2       | Toast notification configuration       | UI component logic               |
| 2.2-INT-010  | Integration | P2       | Success callback triggers notification | Component interaction            |

### AC7: Basic form validation ensures title and author provided

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-010 | Unit        | P0       | Title validation - empty string        | Critical validation logic        |
| 2.2-UNIT-011 | Unit        | P0       | Author validation - empty string       | Critical validation logic        |
| 2.2-UNIT-012 | Unit        | P1       | Title validation - character limits    | Business rules validation       |
| 2.2-UNIT-013 | Unit        | P1       | Author validation - character limits   | Business rules validation       |

### AC8: Added books immediately appear in book list

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-INT-011  | Integration | P0       | Cache invalidation after creation     | Real-time data sync critical     |
| 2.2-INT-012  | Integration | P1       | Book appears in filtered list          | Search integration               |
| 2.2-E2E-005  | E2E         | P0       | User sees new book in list immediately | **Critical user expectation**   |

### AC9: No complex cataloging fields in initial version

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-UNIT-014 | Unit        | P2       | Form schema excludes complex fields    | Requirements compliance          |

## High-Risk Scenario Coverage

### Database Transaction Integrity (TECH-001, DATA-002)

| ID           | Level       | Priority | Test                                    | Risk Mitigation                  |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-INT-013  | Integration | P0       | **Atomic book creation transaction**   | **TECH-001, DATA-002**          |
| 2.2-INT-014  | Integration | P0       | **Transaction rollback on failure**    | **DATA-002**                    |
| 2.2-INT-015  | Integration | P0       | **No orphaned records after failure**  | **DATA-002**                    |
| 2.2-INT-016  | Integration | P1       | **Concurrent book creation safety**     | **TECH-001**                    |

### Performance and Scalability (PERF-001)

| ID           | Level       | Priority | Test                                    | Risk Mitigation                  |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 2.2-INT-017  | Integration | P1       | **Duplicate query with 1000+ books**   | **PERF-001**                    |
| 2.2-INT-018  | Integration | P1       | **Form response time under load**       | **PERF-001**                    |

## Risk Coverage Matrix

| Risk ID   | Test Scenarios                     | Coverage Level |
| --------- | ---------------------------------- | -------------- |
| TECH-001  | 2.2-INT-013, 2.2-INT-014, 2.2-INT-016 | Comprehensive  |
| DATA-002  | 2.2-INT-013, 2.2-INT-014, 2.2-INT-015 | Comprehensive  |
| PERF-001  | 2.2-INT-006, 2.2-INT-017, 2.2-INT-018 | Adequate       |
| DATA-001  | 2.2-INT-007, 2.2-E2E-004          | Adequate       |

## Test Scenario Details

### Critical Path Tests (P0)

#### 2.2-INT-013: Atomic Book Creation Transaction ⭐ **HIGH RISK**
```yaml
test_scenario:
  id: "2.2-INT-013"
  requirement: "Database transaction integrity"
  priority: P0
  level: integration
  description: "Verify entire book creation (authors → general_books → book_editions → book_contributors → book_copies) executes atomically"
  justification: "Mitigates TECH-001 and DATA-002 - critical data integrity"
  test_data:
    - Valid book with new author
    - Valid book with existing author
  assertions:
    - All 5 tables updated successfully OR none updated
    - Transaction ID consistent across all records
    - Referential integrity maintained
  failure_injection:
    - Network interruption after each step
    - Database constraint violations
    - Timeout scenarios
```

#### 2.2-INT-014: Transaction Rollback on Failure ⭐ **HIGH RISK**
```yaml
test_scenario:
  id: "2.2-INT-014" 
  requirement: "Error handling and data consistency"
  priority: P0
  level: integration
  description: "Verify transaction rollback when any step fails in book creation chain"
  justification: "Prevents orphaned records (DATA-002)"
  failure_scenarios:
    - Author creation fails (duplicate canonical name)
    - Book edition creation fails (constraint violation)
    - Book copy creation fails (invalid library_id)
  assertions:
    - No partial records remain in any table
    - Database state unchanged from before attempt
    - Appropriate error returned to client
```

#### 2.2-INT-006: Duplicate Detection Query Performance ⭐ **PERFORMANCE RISK**
```yaml
test_scenario:
  id: "2.2-INT-006"
  requirement: "AC4 - Duplicate detection"
  priority: P0
  level: integration
  description: "Verify duplicate detection query performs adequately with realistic data volume"
  justification: "Mitigates PERF-001 - form submission must be responsive"
  test_data:
    - 5000 existing books with varied titles/authors
    - Query for book with similar title/author
  performance_criteria:
    - Query completes in <2 seconds
    - CPU usage stays <80%
    - Memory usage reasonable
  variations:
    - Exact title/author match
    - Similar title/different author
    - Different title/similar author
```

### Core User Journey Tests (P1)

#### 2.2-E2E-001: Basic Book Creation Journey
```yaml
test_scenario:
  id: "2.2-E2E-001"
  requirement: "AC1, AC7, AC8"
  priority: P1
  level: e2e
  description: "User successfully creates book with required fields only"
  user_journey:
    1. Navigate to Add Book page
    2. Fill required fields (title, author)
    3. Leave optional fields empty
    4. Submit form
    5. See success notification
    6. Navigate to book list
    7. Verify new book appears
  success_criteria:
    - Form submission successful
    - Book appears in list within 5 seconds
    - Book has "available" status
```

#### 2.2-E2E-004: Duplicate Detection User Experience
```yaml
test_scenario:
  id: "2.2-E2E-004"
  requirement: "AC4"
  priority: P1
  level: e2e
  description: "User encounters duplicate detection and handles appropriately"
  preconditions:
    - Existing book "The Great Gatsby" by "F. Scott Fitzgerald"
  user_journey:
    1. Navigate to Add Book page
    2. Enter duplicate title/author
    3. Submit form
    4. See duplicate warning dialog
    5. Choose to cancel or override
  success_criteria:
    - Clear duplicate warning displayed
    - User can cancel or proceed with justification
    - No duplicate created if cancelled
```

## Performance Test Requirements

### Load Testing Scenarios

**Duplicate Detection Scale Test**:
- **Data Volume**: 5,000 existing books
- **Concurrent Users**: 10 staff members
- **Query Types**: Exact match, fuzzy match, no match
- **Success Criteria**: <2s response time, <5% error rate

**Book Creation Throughput Test**:
- **Scenario**: Multiple staff adding books simultaneously
- **Volume**: 100 books/hour peak rate
- **Success Criteria**: No transaction conflicts, no data corruption

## Recommended Test Execution Order

### Phase 1: Critical Safety (P0) - **FAIL FAST**
1. **Database Transaction Tests** (2.2-INT-013, 2.2-INT-014, 2.2-INT-015)
2. **Validation Tests** (2.2-UNIT-001, 2.2-UNIT-010, 2.2-UNIT-011)
3. **Duplicate Detection** (2.2-INT-006, 2.2-INT-007)
4. **Data Integrity** (2.2-INT-009, 2.2-INT-011)

### Phase 2: Core Functionality (P1)
1. **User Journeys** (2.2-E2E-001, 2.2-E2E-003, 2.2-E2E-004)
2. **Integration Points** (2.2-INT-001, 2.2-INT-004, 2.2-INT-005)
3. **Performance Validation** (2.2-INT-017, 2.2-INT-018)

### Phase 3: Polish & Edge Cases (P2)
1. **ISBN Lookup** (2.2-INT-003, 2.2-E2E-002)
2. **UI/UX Tests** (2.2-INT-010, 2.2-UNIT-009)
3. **Compliance** (2.2-UNIT-014)

## Test Environment Requirements

### Unit Test Environment
- **Framework**: Vitest with TypeScript
- **Mocking**: Mock Supabase client, external services
- **Coverage Target**: >90% for validation logic

### Integration Test Environment  
- **Database**: Dedicated test Supabase instance
- **Data Management**: Fresh seed data for each test suite
- **Isolation**: Transaction rollback between tests

### E2E Test Environment
- **Browser**: Playwright with multiple browsers
- **Database**: Staging environment with realistic data
- **Services**: Mock crawler service with configurable responses

## Coverage Gaps and Risks

### Identified Gaps
- **None** - All ACs have appropriate test coverage

### Testing Risks
1. **External Service Dependency**: Crawler service mocking may not reflect real behavior
2. **Performance Testing**: May not scale to production data volumes
3. **Concurrent Testing**: Difficult to simulate real multi-user scenarios

### Mitigation Strategies
- **Staging Environment Testing**: Run critical tests against real services
- **Gradual Rollout**: Feature flags for controlled deployment
- **Monitoring**: Comprehensive production metrics for early issue detection

## Test Maintenance Strategy

### Stable Tests (Low Maintenance)
- Unit tests for validation logic
- Database transaction tests
- Core user journey tests

### Brittle Tests (High Maintenance)
- E2E tests with UI dependencies
- External service integration tests
- Performance tests sensitive to data changes

### Maintenance Schedule
- **Weekly**: Review E2E test failures
- **Sprint**: Update test data for realistic scenarios
- **Release**: Validate all P0 and P1 tests pass

---

**Test Design Confidence**: High - Comprehensive coverage with risk-based prioritization  
**Implementation Effort**: 15-20 developer days for complete test suite  
**Maintenance Effort**: 2-3 hours per sprint for test suite maintenance