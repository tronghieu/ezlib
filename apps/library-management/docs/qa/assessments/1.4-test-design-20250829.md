# Test Design: Story 1.4 - Library Context Management

Date: 2025-08-29  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 52
- Unit tests: 22 (42%)
- Integration tests: 20 (39%)
- E2E tests: 10 (19%)
- Priority distribution: P0: 25, P1: 18, P2: 9

## Test Scenarios by Acceptance Criteria

### AC1: Library Selection Landing Page

#### Scenarios

| ID           | Level       | Priority | Test                               | Justification                 |
| ------------ | ----------- | -------- | ---------------------------------- | ----------------------------- |
| 1.4-UNIT-001 | Unit        | P0       | Validate library access filter     | Critical security logic       |
| 1.4-INT-001  | Integration | P0       | Fetch user libraries from database | Multi-component data flow     |
| 1.4-INT-002  | Integration | P0       | Authentication redirect logic      | Security-critical path        |
| 1.4-E2E-001  | E2E         | P0       | Complete library selection flow    | Revenue-critical user journey |
| 1.4-UNIT-002 | Unit        | P1       | Library card data rendering        | UI component logic            |
| 1.4-INT-003  | Integration | P1       | Grid layout responsiveness         | Cross-component interaction   |
| 1.4-E2E-002  | E2E         | P1       | Navigation to library dashboard    | Core user journey validation  |

### AC2: Library Context Provider Implementation

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                  |
| ------------ | ----------- | -------- | ----------------------------------- | ------------------------------ |
| 1.4-UNIT-003 | Unit        | P0       | Context state initialization        | Core state management logic    |
| 1.4-UNIT-004 | Unit        | P0       | Context reducer actions             | Critical state transitions     |
| 1.4-UNIT-005 | Unit        | P0       | Context state validation            | Data integrity protection      |
| 1.4-INT-004  | Integration | P0       | Context provider wrapping app       | Component integration critical |
| 1.4-INT-005  | Integration | P0       | Context updates trigger re-renders  | Performance-critical behavior  |
| 1.4-UNIT-006 | Unit        | P1       | Context hook error handling         | Proper error boundaries        |
| 1.4-INT-006  | Integration | P1       | Multi-component context consumption | Component interaction flow     |

### AC3: Library Access Validation

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                  |
| ------------ | ----------- | -------- | ------------------------------------ | ------------------------------ |
| 1.4-UNIT-007 | Unit        | P0       | Library access permission validation | Security-critical logic        |
| 1.4-UNIT-008 | Unit        | P0       | Role-based filtering logic           | Access control business logic  |
| 1.4-INT-007  | Integration | P0       | Database query with RLS enforcement  | Multi-tenant security          |
| 1.4-INT-008  | Integration | P0       | Auth state change library refresh    | Security state synchronization |
| 1.4-UNIT-009 | Unit        | P1       | No access error message generation   | Error handling logic           |
| 1.4-INT-009  | Integration | P1       | Library access cache invalidation    | Data consistency management    |
| 1.4-E2E-003  | E2E         | P1       | Permission-based library visibility  | End-to-end security validation |

### AC4: Library Selection Interface

#### Scenarios

| ID           | Level       | Priority | Test                             | Justification                 |
| ------------ | ----------- | -------- | -------------------------------- | ----------------------------- |
| 1.4-UNIT-010 | Unit        | P0       | Single library auto-selection    | Critical UX logic             |
| 1.4-UNIT-011 | Unit        | P1       | Library dropdown data formatting | UI data transformation        |
| 1.4-UNIT-012 | Unit        | P1       | Search filtering logic           | User experience enhancement   |
| 1.4-INT-010  | Integration | P1       | Library switcher component flow  | Component interaction         |
| 1.4-E2E-004  | E2E         | P1       | Library switching user journey   | Core functionality validation |
| 1.4-UNIT-013 | Unit        | P2       | Loading state management         | UI state handling             |
| 1.4-UNIT-014 | Unit        | P2       | Empty state display logic        | Edge case handling            |

### AC5: Context Persistence and Restoration

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                |
| ------------ | ----------- | -------- | ------------------------------------ | ---------------------------- |
| 1.4-UNIT-015 | Unit        | P0       | localStorage save/load operations    | Data persistence logic       |
| 1.4-UNIT-016 | Unit        | P0       | Invalid selection graceful handling  | Error recovery logic         |
| 1.4-INT-011  | Integration | P0       | Context restoration on app init      | Critical app initialization  |
| 1.4-INT-012  | Integration | P0       | Cross-session persistence validation | Data consistency requirement |
| 1.4-UNIT-017 | Unit        | P1       | Default selection logic              | UX fallback behavior         |
| 1.4-E2E-005  | E2E         | P1       | Browser refresh selection restore    | User experience validation   |
| 1.4-UNIT-018 | Unit        | P2       | Storage quota error handling         | Edge case resilience         |

### AC6: Library-Scoped Data Operations

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                  |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------ |
| 1.4-UNIT-019 | Unit        | P0       | Automatic library ID filtering          | Data isolation logic           |
| 1.4-UNIT-020 | Unit        | P0       | Data operation prevention without lib   | Security boundary enforcement  |
| 1.4-INT-013  | Integration | P0       | Library-scoped database queries         | Multi-tenant data isolation    |
| 1.4-INT-014  | Integration | P0       | Context passing to data hooks           | Component integration critical |
| 1.4-INT-015  | Integration | P0       | Real-time subscription scoping          | Performance and security       |
| 1.4-E2E-006  | E2E         | P0       | Cross-library data isolation validation | Security compliance testing    |
| 1.4-INT-016  | Integration | P1       | Library switch updates subscriptions    | Data consistency management    |

### AC7: Multi-Tenant UI Integration

#### Scenarios

| ID           | Level       | Priority | Test                               | Justification               |
| ------------ | ----------- | -------- | ---------------------------------- | --------------------------- |
| 1.4-UNIT-021 | Unit        | P1       | Header library display logic       | UI component correctness    |
| 1.4-UNIT-022 | Unit        | P1       | Breadcrumb context integration     | Navigation component logic  |
| 1.4-INT-017  | Integration | P1       | Library switcher in navigation     | UI component integration    |
| 1.4-INT-018  | Integration | P1       | Loading states during switching    | User experience flow        |
| 1.4-E2E-007  | E2E         | P1       | Complete library switching journey | End-to-end UX validation    |
| 1.4-E2E-008  | E2E         | P2       | Visual library context indicators  | UI consistency validation   |
| 1.4-INT-019  | Integration | P2       | Multi-library admin interface      | Advanced feature validation |

### Additional Security & Performance Tests

#### Security Testing

| ID          | Level       | Priority | Test                                 | Justification               |
| ----------- | ----------- | -------- | ------------------------------------ | --------------------------- |
| 1.4-INT-020 | Integration | P0       | Cross-tenant data leak prevention    | Critical security boundary  |
| 1.4-E2E-009 | E2E         | P0       | Unauthorized library access attempts | Security compliance testing |

#### Performance Testing

| ID          | Level | Priority | Test                               | Justification          |
| ----------- | ----- | -------- | ---------------------------------- | ---------------------- |
| 1.4-E2E-010 | E2E   | P2       | Context provider performance bench | Scalability validation |

## Risk Coverage

### Critical Security Risks

- **RISK-001**: Cross-library data exposure
  - Mitigated by: 1.4-INT-013, 1.4-INT-020, 1.4-E2E-006, 1.4-E2E-009
- **RISK-002**: Unauthorized library access
  - Mitigated by: 1.4-UNIT-007, 1.4-INT-007, 1.4-E2E-003, 1.4-E2E-009
- **RISK-003**: Context corruption causing data loss
  - Mitigated by: 1.4-UNIT-003, 1.4-UNIT-005, 1.4-INT-011

### Performance Risks

- **RISK-004**: Context provider causing excessive re-renders
  - Mitigated by: 1.4-INT-005, 1.4-E2E-010
- **RISK-005**: Memory leaks in library switching
  - Mitigated by: 1.4-INT-016, 1.4-E2E-010

### Data Integrity Risks

- **RISK-006**: Invalid library selection persistence
  - Mitigated by: 1.4-UNIT-016, 1.4-INT-012
- **RISK-007**: Library access validation bypass
  - Mitigated by: 1.4-UNIT-008, 1.4-INT-008

## Detailed Test Scenarios

### P0 Critical Tests (Must Implement Before Production)

#### 1.4-UNIT-001: Validate library access filter

- **Given**: User with mixed library permissions (admin: 2, member: 1)
- **When**: Library access filter applied
- **Then**: Only admin-accessible libraries returned (2 libraries)

#### 1.4-INT-001: Fetch user libraries from database

- **Given**: Authenticated user with library_staff records
- **When**: fetchUserLibraries called with user ID
- **Then**: Libraries fetched with correct RLS filtering and user role info

#### 1.4-INT-002: Authentication redirect logic

- **Given**: Unauthenticated user accessing library selection
- **When**: Page component mounts
- **Then**: User redirected to /auth/login, library selection blocked

#### 1.4-E2E-001: Complete library selection flow

- **Given**: User with access to multiple libraries
- **When**: User visits landing page and selects library
- **Then**: Navigation to correct /[library-code]/dashboard, context updated

#### 1.4-UNIT-003: Context state initialization

- **Given**: LibraryProvider mounting with no previous state
- **When**: Provider initializes
- **Then**: Default state set (no library, loading false, empty libraries array)

#### 1.4-UNIT-004: Context reducer actions

- **Given**: Library context with initial state
- **When**: SET_CURRENT_LIBRARY action dispatched
- **Then**: Current library updated, localStorage saved, loading reset

#### 1.4-UNIT-005: Context state validation

- **Given**: Context with invalid library selection
- **When**: State validation runs
- **Then**: Invalid selection cleared, default state restored

#### 1.4-INT-004: Context provider wrapping app

- **Given**: App component hierarchy with LibraryProvider
- **When**: Child components access context
- **Then**: Context available throughout component tree

#### 1.4-INT-005: Context updates trigger re-renders

- **Given**: Multiple components consuming library context
- **When**: Library selection changes
- **Then**: Only consuming components re-render, others unchanged

#### 1.4-UNIT-007: Library access permission validation

- **Given**: Library with specific permissions requirement
- **When**: validateLibraryAccess called with user permissions
- **Then**: Access granted/denied based on permission match

#### 1.4-UNIT-008: Role-based filtering logic

- **Given**: User libraries with different roles (admin, manager, librarian)
- **When**: filterLibrariesByRole called with "admin" requirement
- **Then**: Only admin-role libraries returned

#### 1.4-INT-007: Database query with RLS enforcement

- **Given**: Database with RLS policies enabled
- **When**: Library query executed with user context
- **Then**: Only authorized libraries returned, unauthorized blocked

#### 1.4-INT-008: Auth state change library refresh

- **Given**: User authentication state changes (login/logout)
- **When**: Auth context updates
- **Then**: Library access refreshed, context reset if needed

#### 1.4-UNIT-010: Single library auto-selection

- **Given**: User with access to exactly one library
- **When**: Library context initializes
- **Then**: Single library auto-selected, navigation not required

#### 1.4-UNIT-015: localStorage save/load operations

- **Given**: Library selection made by user
- **When**: saveSelectedLibraryToStorage called
- **Then**: Selection saved with user-specific key, retrievable on reload

#### 1.4-UNIT-016: Invalid selection graceful handling

- **Given**: localStorage contains library ID user no longer accesses
- **When**: loadSelectedLibraryFromStorage called
- **Then**: Invalid selection cleared, no error thrown

#### 1.4-INT-011: Context restoration on app init

- **Given**: App initializing with stored library selection
- **When**: Context provider mounts and loads storage
- **Then**: Previous selection restored if still valid

#### 1.4-INT-012: Cross-session persistence validation

- **Given**: Library selection made in previous browser session
- **When**: New browser session starts
- **Then**: Selection restored from localStorage correctly

#### 1.4-UNIT-019: Automatic library ID filtering

- **Given**: Data operation hook with selected library context
- **When**: Database query built
- **Then**: library_id filter automatically applied to query

#### 1.4-UNIT-020: Data operation prevention without library

- **Given**: No library currently selected in context
- **When**: Data operation attempted
- **Then**: Error thrown, operation prevented

#### 1.4-INT-013: Library-scoped database queries

- **Given**: Selected library context with specific library ID
- **When**: useLibraryBooks hook executes query
- **Then**: Results filtered to selected library only

#### 1.4-INT-014: Context passing to data hooks

- **Given**: Component using library data hooks
- **When**: Hook accesses current library context
- **Then**: Context values correctly passed to all data operations

#### 1.4-INT-015: Real-time subscription scoping

- **Given**: Library-specific real-time subscription
- **When**: Subscription created with library context
- **Then**: Only events for current library received

#### 1.4-E2E-006: Cross-library data isolation validation

- **Given**: User switches between different libraries
- **When**: Data queries executed for each library
- **Then**: Data completely isolated, no cross-library contamination

#### 1.4-INT-020: Cross-tenant data leak prevention

- **Given**: Malicious attempt to access other library's data
- **When**: Database query executed with injected library ID
- **Then**: Query blocked by RLS, no unauthorized data returned

#### 1.4-E2E-009: Unauthorized library access attempts

- **Given**: User attempts to access library without permissions
- **When**: Direct navigation to restricted library dashboard
- **Then**: Access denied, user redirected to authorized libraries

## Recommended Execution Order

1. **Phase 1: P0 Unit Tests (Critical Logic)**
   - 1.4-UNIT-001 through 1.4-UNIT-020
   - Fast feedback on core business logic
   - Must pass before any integration testing

2. **Phase 2: P0 Integration Tests (Critical Flows)**
   - 1.4-INT-001 through 1.4-INT-020
   - Database integration and component interaction
   - Security boundary validation

3. **Phase 3: P0 E2E Tests (Critical Journeys)**
   - 1.4-E2E-001, 1.4-E2E-006, 1.4-E2E-009
   - End-to-end security and functionality validation
   - Production-readiness verification

4. **Phase 4: P1 Tests (Important Features)**
   - All P1 tests across all levels
   - Core user experience validation

5. **Phase 5: P2 Tests (Nice to Have)**
   - P2 tests as time and resources permit
   - Polish and edge case coverage

## Quality Gates

### Pre-Production Requirements

- **CRITICAL**: All 25 P0 tests must pass
- **REQUIRED**: At least 80% of P1 tests must pass
- **RECOMMENDED**: P2 test execution attempted

### Performance Benchmarks

- Library context switching: < 200ms
- Library selection page load: < 1 second
- Memory usage with 50+ libraries: < 100MB overhead

### Security Validation

- Cross-tenant data isolation: 100% verified
- Permission boundary enforcement: 100% verified
- RLS policy effectiveness: 100% verified

## Implementation Notes

### Test Environment Setup

```typescript
// Test setup for library context testing
const mockSupabase = {
  from: jest.fn(() => ({
    select: jest.fn(() => ({
      eq: jest.fn(() => ({
        data: mockLibraries,
        error: null
      }))
    }))
  })),
  auth: {
    getUser: jest.fn(() => ({
      data: { user: mockUser },
      error: null
    }))
  }
};

const TestLibraryProvider = ({ children, initialState }) => (
  <LibraryProvider initialState={initialState}>
    {children}
  </LibraryProvider>
);
```

### Mock Data Requirements

- **Mock Users**: Admin, Manager, Librarian roles
- **Mock Libraries**: Single-library, multi-library scenarios
- **Mock Permissions**: Various permission combinations
- **Mock Database**: RLS policy simulation

### Test Data Isolation

Each test must:

- Create fresh mock data
- Reset localStorage before execution
- Clean up context state after completion
- Ensure no test interdependencies

## Risk Assessment Summary

- **CRITICAL RISK**: Multi-tenant foundation without tests
- **HIGH RISK**: Security boundaries untested
- **HIGH RISK**: Core functionality unvalidated
- **MEDIUM RISK**: Performance characteristics unknown

## Final Recommendations

1. **IMMEDIATE**: Implement all 25 P0 tests before any production deployment
2. **HIGH PRIORITY**: Complete P1 test suite for production readiness
3. **ONGOING**: Monitor test execution time and maintain < 30 second P0 suite
4. **FUTURE**: Add load testing for libraries with 10,000+ books/members

This test design provides comprehensive coverage for the critical multi-tenant library context management system with appropriate prioritization and risk-based validation.
