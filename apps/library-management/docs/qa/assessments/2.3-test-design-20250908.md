# Test Design: Story 2.3 - Book Details and Management

**Date:** 2025-09-08  
**Designer:** Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios:** 28
- **Unit tests:** 9 (32%)
- **Integration tests:** 12 (43%)
- **E2E tests:** 7 (25%)
- **Priority distribution:** P0: 11, P1: 12, P2: 5

## Test Scenarios by Acceptance Criteria

### AC1: Book copy detail view displays complete metadata including book editions details

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                          |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------------- |
| 2.3-UNIT-001 | Unit        | P1       | BookCopyDetail component renders metadata | Component rendering logic             |
| 2.3-UNIT-002 | Unit        | P1       | Format display values correctly         | Data transformation pure functions     |
| 2.3-INT-001  | Integration | P0       | Fetch book copy with complete metadata  | Critical data retrieval operation      |
| 2.3-E2E-001  | E2E         | P1       | View book details from books list       | Core user journey                      |

### AC2: Edit functionality for all book copy fields except book edition information

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-UNIT-003 | Unit        | P0       | Validate book copy update schema     | Business rules validation              |
| 2.3-UNIT-004 | Unit        | P1       | EditBookCopyForm validation logic    | Form validation pure functions         |
| 2.3-INT-002  | Integration | P0       | Update book copy via API             | Critical data modification operation   |
| 2.3-INT-003  | Integration | P0       | Prevent edition field modifications  | Data integrity constraint              |
| 2.3-E2E-002  | E2E         | P1       | Complete edit workflow               | Core edit user journey                 |

### AC3: Book copy location management with validation against library layout

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-UNIT-005 | Unit        | P1       | Location validation schema           | Pure validation logic                  |
| 2.3-INT-004  | Integration | P1       | Location field updates               | Database field operations              |
| 2.3-E2E-003  | E2E         | P2       | Location management workflow         | Secondary feature validation           |

### AC4: Book condition tracking with notes field

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-UNIT-006 | Unit        | P1       | Condition enum validation            | Business rule validation               |
| 2.3-INT-005  | Integration | P1       | Condition updates with notes         | Structured data operations             |
| 2.3-E2E-004  | E2E         | P2       | Condition tracking workflow          | Secondary feature validation           |

### AC5: Historical view of circulation activity and maintenance records

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-UNIT-007 | Unit        | P1       | CirculationHistory component logic   | Display component rendering            |
| 2.3-INT-006  | Integration | P0       | Fetch circulation history            | Critical historical data retrieval     |
| 2.3-INT-007  | Integration | P1       | History query performance            | Performance-critical query             |
| 2.3-E2E-005  | E2E         | P1       | View circulation history             | Core information access journey        |

### AC6: Delete/remove book copies functionality with confirmation and audit trail

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-UNIT-008 | Unit        | P1       | DeleteDialog confirmation logic      | UI interaction logic                   |
| 2.3-INT-008  | Integration | P0       | Soft delete with audit trail        | Critical data integrity operation      |
| 2.3-INT-009  | Integration | P0       | Prevent delete with active borrows   | Business rule enforcement              |
| 2.3-INT-010  | Integration | P1       | Audit trail creation                 | Compliance tracking                    |
| 2.3-E2E-006  | E2E         | P0       | Complete delete workflow             | Critical destructive operation         |

### AC7: Role restrictions for editing book copies (view all, edit librarian+)

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-UNIT-009 | Unit        | P0       | Role-based UI component rendering    | Security access control logic          |
| 2.3-INT-011  | Integration | P0       | API authorization enforcement        | Critical security boundary             |
| 2.3-INT-012  | Integration | P0       | RLS policy validation                | Database-level security                |
| 2.3-E2E-007  | E2E         | P0       | Role-based access workflows          | Security compliance validation         |

## Cross-Cutting Concerns

### Error Handling & Edge Cases

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-INT-013  | Integration | P0       | Handle non-existent book copy        | Error handling for invalid requests    |
| 2.3-INT-014  | Integration | P1       | Handle network failures gracefully   | Resilience testing                     |
| 2.3-E2E-008  | E2E         | P1       | 404 error page display               | User experience for errors             |

### Performance & Scalability

| ID           | Level       | Priority | Test                                 | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------------- |
| 2.3-INT-015  | Integration | P2       | Large circulation history rendering  | Performance under load                 |
| 2.3-INT-016  | Integration | P2       | Concurrent edit handling             | Data consistency under concurrency    |

## Risk Coverage Analysis

**High-Risk Scenarios (Addressed by P0 tests):**

- **Data Loss Prevention:** 2.3-INT-008, 2.3-E2E-006 (Soft delete audit trail)
- **Security Breach:** 2.3-UNIT-009, 2.3-INT-011, 2.3-INT-012, 2.3-E2E-007 (Role restrictions)
- **Data Corruption:** 2.3-INT-001, 2.3-INT-002, 2.3-INT-003 (Data integrity)
- **Business Logic Violation:** 2.3-UNIT-003, 2.3-INT-009 (Constraint enforcement)

## Recommended Execution Order

### Phase 1: Critical Path Validation (P0 - Must Pass)
1. **Unit Tests:** 2.3-UNIT-003, 2.3-UNIT-009 (Business logic and security)
2. **Integration Tests:** 2.3-INT-001, 2.3-INT-002, 2.3-INT-008, 2.3-INT-011, 2.3-INT-012 (Data and security operations)
3. **E2E Tests:** 2.3-E2E-006, 2.3-E2E-007 (Critical user journeys)

### Phase 2: Core Functionality (P1 - Should Pass)
1. **Unit Tests:** 2.3-UNIT-001, 2.3-UNIT-002, 2.3-UNIT-004, 2.3-UNIT-005, 2.3-UNIT-006, 2.3-UNIT-007, 2.3-UNIT-008
2. **Integration Tests:** 2.3-INT-004, 2.3-INT-005, 2.3-INT-007, 2.3-INT-010, 2.3-INT-014
3. **E2E Tests:** 2.3-E2E-001, 2.3-E2E-002, 2.3-E2E-005, 2.3-E2E-008

### Phase 3: Secondary Features (P2 - Nice to Have)
1. **Integration Tests:** 2.3-INT-015, 2.3-INT-016
2. **E2E Tests:** 2.3-E2E-003, 2.3-E2E-004

## Test Environment Requirements

### Unit Tests
- **Framework:** Jest with React Testing Library
- **Mocking:** Mock Supabase client, React Router, library context
- **Test Data:** Factory pattern for consistent test book copies

### Integration Tests
- **Framework:** Jest with Supabase test client
- **Database:** In-memory or containerized PostgreSQL with test fixtures
- **Authentication:** Mock authenticated user sessions with different roles

### E2E Tests
- **Framework:** Playwright
- **Environment:** Full application stack with test database
- **Data Setup:** Seeded test data with known book copies and users

## Test Data Strategy

### Core Test Entities
- **Test Library:** "TEST-LIB" with all role types
- **Test Book Copies:** Various conditions, locations, circulation histories
- **Test Users:** Different role levels (volunteer, librarian, manager, owner)
- **Test Transactions:** Active borrows, completed returns, overdue items

### Data Isolation
- Each test suite uses separate database transactions
- Cleanup after each test execution
- No dependencies between test scenarios

## Maintenance Considerations

### Test Stability Factors
- **UI Selectors:** Use data-testid attributes for stable E2E selectors
- **API Contracts:** Version test schemas with API changes
- **Role Management:** Centralize role-based test utilities

### Monitoring & Alerting
- Track test execution time trends
- Monitor flaky test patterns
- Alert on P0 test failures in CI/CD

## Success Criteria

### Definition of Done for Testing
- [ ] All P0 tests pass consistently
- [ ] P1 test coverage >80%
- [ ] All role-based access scenarios validated
- [ ] Performance benchmarks established
- [ ] Error handling pathways covered
- [ ] Audit trail functionality verified

This comprehensive test design ensures robust coverage of all acceptance criteria while maintaining efficient test execution and clear risk mitigation strategies.