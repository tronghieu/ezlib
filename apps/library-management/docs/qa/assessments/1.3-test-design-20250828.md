# Test Design: Story 1.3 - Cross-Domain Passwordless Authentication System

Date: 2025-08-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios:** 37
- **Unit tests:** 15 (41%)
- **Integration tests:** 14 (38%)  
- **E2E tests:** 8 (21%)
- **Priority distribution:** P0: 18, P1: 12, P2: 5, P3: 2

## Test Scenarios by Acceptance Criteria

### AC1: Authentication Middleware Implementation

#### Scenarios

| ID           | Level       | Priority | Test Scenario                           | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ | -------------- |
| 1.3-UNIT-001 | Unit        | P0       | Route protection logic validation       | Pure middleware function logic             | TECH-002       |
| 1.3-UNIT-002 | Unit        | P0       | Session validation token parsing        | Security-critical token handling           | SEC-002        |
| 1.3-UNIT-003 | Unit        | P0       | Redirect URL generation                 | Pure utility function                      | TECH-003       |
| 1.3-INT-001  | Integration | P0       | Middleware blocks protected routes      | Multi-component security boundary          | SEC-001        |
| 1.3-INT-002  | Integration | P0       | Session refresh flow                    | Critical auth service interaction          | SEC-002        |
| 1.3-E2E-001  | E2E         | P0       | Unauthenticated user redirect          | Critical security path                     | BUS-002        |
| 1.3-E2E-002  | E2E         | P1       | Post-auth redirect to intended page    | User experience flow                       | TECH-003       |

### AC2: Login Interface Implementation

#### Scenarios

| ID           | Level       | Priority | Test Scenario                           | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ | -------------- |
| 1.3-UNIT-004 | Unit        | P0       | Email validation regex                  | Input validation pure function             | SEC-001        |
| 1.3-UNIT-005 | Unit        | P1       | Form state management                   | Complex client-side state logic           | TECH-003       |
| 1.3-UNIT-006 | Unit        | P1       | Error message display logic            | UI state calculation                       | -              |
| 1.3-INT-003  | Integration | P0       | OTP request API call                    | Critical service integration               | OPS-001        |
| 1.3-INT-004  | Integration | P1       | Loading state management                | Component interaction                      | PERF-001       |
| 1.3-E2E-003  | E2E         | P0       | Complete login flow                     | Revenue-critical user journey              | BUS-002        |
| 1.3-E2E-004  | E2E         | P1       | Registration messaging display         | User experience validation                 | -              |

### AC3: Authentication Callback Handling

#### Scenarios

| ID           | Level       | Priority | Test Scenario                           | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ | -------------- |
| 1.3-UNIT-007 | Unit        | P0       | OTP token validation                    | Security-critical validation logic         | SEC-001        |
| 1.3-UNIT-008 | Unit        | P0       | Session data extraction                 | Pure data transformation                   | SEC-002        |
| 1.3-UNIT-009 | Unit        | P0       | Error handling logic                    | Complex branching logic                    | TECH-003       |
| 1.3-INT-005  | Integration | P0       | Token exchange with Supabase           | Critical external service integration      | TECH-001       |
| 1.3-INT-006  | Integration | P0       | Session establishment                   | Database and auth service interaction      | SEC-002        |
| 1.3-INT-007  | Integration | P1       | Redirect handling                       | Multi-component flow                       | TECH-003       |
| 1.3-E2E-005  | E2E         | P0       | OTP callback success flow              | Critical security path                     | BUS-002        |
| 1.3-E2E-006  | E2E         | P1       | OTP callback failure scenarios         | Error path user experience                 | BUS-002        |

### AC4: Permission System Integration

#### Scenarios

| ID           | Level       | Priority | Test Scenario                           | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ | -------------- |
| 1.3-UNIT-010 | Unit        | P0       | Role-based permission calculation       | Complex business logic                     | SEC-003        |
| 1.3-UNIT-011 | Unit        | P0       | Permission matrix validation            | Security-critical logic                    | SEC-003        |
| 1.3-UNIT-012 | Unit        | P1       | Permission hook state management        | Complex hook logic                         | TECH-003       |
| 1.3-INT-008  | Integration | P0       | Database permission queries             | Security-critical DB interaction           | SEC-003        |
| 1.3-INT-009  | Integration | P0       | Server-side permission enforcement      | Critical API security boundary             | SEC-003        |
| 1.3-INT-010  | Integration | P1       | Client-side permission UI updates      | Multi-component interaction                | -              |
| 1.3-E2E-007  | E2E         | P0       | Role-based access control              | Security compliance requirement            | SEC-003        |

### AC5: Cross-Domain Session Management

#### Scenarios

| ID           | Level       | Priority | Test Scenario                           | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ | -------------- |
| 1.3-UNIT-013 | Unit        | P0       | Session cleanup logic                   | Critical security function                 | SEC-002        |
| 1.3-UNIT-014 | Unit        | P1       | Session state synchronization          | Complex state management                   | TECH-003       |
| 1.3-INT-011  | Integration | P0       | Cross-domain session persistence        | Critical cross-domain functionality        | TECH-001       |
| 1.3-INT-012  | Integration | P1       | Logout cleanup process                  | Multi-component cleanup                    | SEC-002        |
| 1.3-INT-013  | Integration | P2       | Session refresh across navigation       | Browser interaction validation             | DATA-002       |
| 1.3-E2E-008  | E2E         | P1       | Session persistence across refreshes    | User experience validation                 | TECH-001       |

### AC6: Authentication State Management

#### Scenarios

| ID           | Level       | Priority | Test Scenario                           | Justification                              | Mitigates Risk |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ | -------------- |
| 1.3-UNIT-015 | Unit        | P1       | Auth hook state transitions             | Complex hook logic                         | TECH-003       |
| 1.3-INT-014  | Integration | P1       | Real-time auth state updates           | Supabase subscription integration          | TECH-003       |
| 1.3-INT-015  | Integration | P2       | Auth listener cleanup                   | Memory management                          | -              |
| 1.3-INT-016  | Integration | P2       | Context provider state management       | React context behavior                     | TECH-003       |
| 1.3-INT-017  | Integration | P3       | Loading state coordination              | Multi-component state sync                 | -              |

## Risk Coverage Matrix

| Risk ID   | Risk Description                    | Test Coverage                        |
| --------- | ----------------------------------- | ------------------------------------ |
| TECH-001  | Cross-domain session sync failure  | 1.3-INT-005, 1.3-INT-011, 1.3-E2E-008 |
| SEC-001   | OTP interception/replay attacks     | 1.3-UNIT-004, 1.3-UNIT-007, 1.3-INT-001 |
| SEC-002   | Session hijacking across domains    | 1.3-UNIT-002, 1.3-INT-002, 1.3-INT-006, 1.3-UNIT-013 |
| SEC-003   | Privilege escalation                | 1.3-UNIT-010, 1.3-UNIT-011, 1.3-INT-008, 1.3-INT-009, 1.3-E2E-007 |
| TECH-002  | Middleware blocking legitimate requests | 1.3-UNIT-001 |
| TECH-003  | Auth state desynchronization       | 1.3-UNIT-003, 1.3-UNIT-005, 1.3-UNIT-009, 1.3-UNIT-012, 1.3-UNIT-014, 1.3-UNIT-015 |
| BUS-002   | Library staff unable to access     | 1.3-E2E-001, 1.3-E2E-003, 1.3-E2E-005, 1.3-E2E-006 |
| OPS-001   | Email service provider outage      | 1.3-INT-003 |

## Test Implementation Guidelines

### Unit Test Requirements

**Authentication Utilities** (`lib/auth/utils.ts`)
- Email validation with edge cases (invalid formats, special characters)
- Permission calculation functions with all role combinations
- Session token parsing and validation
- Error handling with various error types

**Middleware Logic** (`src/middleware.ts`)  
- Route protection decision logic
- Redirect URL generation
- Session validation without external calls

**State Management** (hooks and context)
- Auth state transitions and side effects
- Loading and error state calculations
- Cleanup logic validation

### Integration Test Requirements

**Authentication Flow Integration**
- Middleware + Supabase Auth helpers integration
- OTP request + email service integration  
- Token exchange + session establishment
- Permission queries + database integration

**Component Integration**
- Login form + auth service integration
- Auth state + UI component updates
- Session management + browser storage

**Database Integration**
- Permission validation queries
- User context retrieval
- Library staff role assignments

### E2E Test Requirements

**Critical User Journeys**
- Complete authentication flow from login to dashboard
- Session persistence across browser refresh and navigation
- Role-based access control across different user types
- Error scenarios with proper user feedback

**Browser Compatibility**
- Chrome, Firefox, Safari, Edge testing
- Mobile and desktop viewport testing
- Cookie and local storage behavior

**Security Validation**
- Unauthenticated access blocked
- Role permissions properly enforced
- Session security measures effective

## Test Data Requirements

### User Test Data
```yaml
test_users:
  owner:
    email: "owner@testlib.com"
    role: "owner"
    library_id: "test-lib-001"
  manager:
    email: "manager@testlib.com"  
    role: "manager"
    library_id: "test-lib-001"
  librarian:
    email: "librarian@testlib.com"
    role: "librarian"
    library_id: "test-lib-001"
  no_access:
    email: "external@example.com"
    role: null
    library_id: null
```

### Permission Matrix Test Data
```yaml
permissions:
  owner: ["read", "write", "delete", "admin"]
  manager: ["read", "write", "admin"]
  librarian: ["read", "write"]
```

## Test Environment Requirements

### Unit Tests
- Jest with TypeScript support
- Mocked Supabase client
- Mocked Next.js request/response objects
- React Testing Library for hook testing

### Integration Tests  
- Test database (in-memory or containerized)
- Mocked email service
- Test Supabase instance
- Network request mocking

### E2E Tests
- Playwright with cross-browser support
- Test email inbox (Ethereal or similar)
- Staging Supabase instance
- Test user accounts pre-provisioned

## Recommended Execution Order

### Phase 1: Critical Path Validation (P0)
1. **Unit Tests First** (Immediate feedback)
   - Authentication utilities (1.3-UNIT-001 to 1.3-UNIT-003)
   - Security validation logic (1.3-UNIT-004, 1.3-UNIT-007)
   - Permission calculations (1.3-UNIT-010, 1.3-UNIT-011)

2. **Integration Tests** (Service boundaries)
   - Middleware protection (1.3-INT-001, 1.3-INT-002)
   - Auth service integration (1.3-INT-003, 1.3-INT-005)
   - Permission enforcement (1.3-INT-008, 1.3-INT-009)

3. **E2E Tests** (Critical user journeys)
   - Complete auth flows (1.3-E2E-001, 1.3-E2E-003, 1.3-E2E-005)
   - Security validation (1.3-E2E-007)

### Phase 2: Core Functionality (P1)
- User experience flows
- Error handling scenarios
- State management validation

### Phase 3: Secondary Features (P2-P3)
- UI polish and messaging
- Performance optimizations
- Advanced state management

## Test Maintenance Considerations

### Stable Tests (Low Maintenance)
- Authentication utility functions
- Permission calculation logic
- Middleware route protection

### Brittle Tests (High Maintenance)
- E2E cross-domain flows
- Real-time state synchronization
- Browser compatibility tests

### Test Data Dependencies
- User accounts and permissions in test database
- Email service configuration
- Cross-domain cookie settings

## Success Metrics

### Test Coverage Targets
- **Unit Test Coverage:** >90% for authentication utilities and business logic
- **Integration Coverage:** >80% for auth flows and security boundaries  
- **E2E Coverage:** 100% of critical user journeys

### Quality Gates
- All P0 tests must pass before deployment
- No security test failures allowed
- Performance tests within acceptable thresholds

### Monitoring Integration
- Test execution time tracking
- Flaky test identification
- Coverage trend monitoring

## Implementation Notes

### Testing Anti-Patterns to Avoid
- Testing framework behavior (Next.js middleware internals)
- Over-mocking in integration tests
- E2E tests for business logic validation
- Testing third-party library behavior (Supabase Auth)

### Test Isolation Requirements
- Each test should be independent and atomic
- Database state reset between integration tests
- Browser state cleanup between E2E tests
- Mock external services consistently

### Performance Considerations
- Unit tests should execute in <100ms each
- Integration tests should complete in <5 seconds each
- E2E tests should finish in <30 seconds each
- Parallel execution where possible