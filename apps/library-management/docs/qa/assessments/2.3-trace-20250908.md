# Requirements Traceability Matrix

**Date:** 2025-09-08  
**Story:** 2.3 - Book Details and Management  
**Tracer:** Quinn (Test Architect)

## Story: 2.3 - Book Details and Management

### Coverage Summary

- **Total Requirements:** 7 (Acceptance Criteria)
- **Fully Covered:** 5 (71%)
- **Partially Covered:** 2 (29%)
- **Not Covered:** 0 (0%)

### Requirement Mappings

#### AC1: Book copy detail view displays complete metadata including book editions details

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `book-copy-detail.test.tsx::should display complete book copy metadata`
  - **Given:** Mock book copy with complete metadata from API
  - **When:** BookCopyDetail component renders
  - **Then:** All metadata fields are displayed (title, author, ISBN, condition, location)

- **Unit Test**: `book-copy-detail.test.tsx::should format display values correctly`
  - **Given:** Raw book copy data with various field formats
  - **When:** Display formatters are applied
  - **Then:** Values are properly formatted for UI display

- **Integration Test**: `book-copy-detail.test.ts::should fetch book copy with complete metadata`
  - **Given:** Valid book copy ID and library ID
  - **When:** API call to fetch detailed book copy information
  - **Then:** Returns complete metadata from joined tables (book_editions, authors, book_contributors)

- **E2E Test**: `book-management.spec.ts::should view book details from books list`
  - **Given:** User on books list page with existing book copies
  - **When:** User clicks on book title to view details
  - **Then:** Detail page loads with complete book information displayed

#### AC2: Edit functionality for all book copy fields except book edition information

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `book-copy.test.ts::should validate book copy update schema`
  - **Given:** Various book copy update data payloads
  - **When:** Validation schema is applied
  - **Then:** Valid data passes, invalid data fails with specific error messages

- **Unit Test**: `edit-book-copy-form.test.tsx::should render editable fields correctly`
  - **Given:** Book copy data with current field values
  - **When:** EditBookCopyForm component renders
  - **Then:** Editable fields are populated, non-editable edition fields are read-only

- **Integration Test**: `book-copy-detail.test.ts::should update book copy via API`
  - **Given:** Valid book copy updates (copy_number, condition, location, notes)
  - **When:** API update call is made
  - **Then:** Database is updated, returns updated book copy data

- **Integration Test**: `book-copy-detail.test.ts::should prevent edition field modifications`
  - **Given:** Update request attempting to modify book edition fields
  - **When:** API validation occurs
  - **Then:** Request is rejected, edition fields remain unchanged

- **E2E Test**: `book-management.spec.ts::should complete edit workflow`
  - **Given:** User with librarian+ role on book detail page
  - **When:** User edits copy fields and saves changes
  - **Then:** Changes are persisted and reflected in UI

#### AC3: Book copy location management with validation against library layout

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `book-copy.test.ts::should validate location schema`
  - **Given:** Various location data combinations (shelf, section, call_number)
  - **When:** Location validation schema is applied
  - **Then:** Valid locations pass, invalid formats fail validation

- **Integration Test**: `book-copy-detail.test.ts::should update location fields`
  - **Given:** Valid location update data
  - **When:** Location fields are updated via API
  - **Then:** Database location JSONB field is updated correctly

**Gap Identified:** No validation against actual library layout/shelf structure

#### AC4: Book condition tracking with notes field

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `book-copy.test.ts::should validate condition enum values`
  - **Given:** Various condition values (valid and invalid)
  - **When:** Condition validation is applied
  - **Then:** Only 'excellent', 'good', 'fair', 'poor' are accepted

- **Integration Test**: `book-copy-detail.test.ts::should update condition with notes`
  - **Given:** Condition update with accompanying notes
  - **When:** Condition and notes are updated
  - **Then:** Database condition_info JSONB field includes condition, notes, and last_maintenance timestamp

- **E2E Test**: `book-management.spec.ts::should track condition changes workflow`
  - **Given:** User editing book copy condition
  - **When:** User selects new condition and adds notes
  - **Then:** Condition is updated with visual indicators and notes are saved

#### AC5: Historical view of circulation activity and maintenance records

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `circulation-history.test.tsx::should render circulation history component`
  - **Given:** Mock circulation history data for book copy
  - **When:** CirculationHistory component renders
  - **Then:** Transaction history is displayed with dates, members, and status

- **Integration Test**: `book-copy-detail.test.ts::should fetch circulation history`
  - **Given:** Book copy with borrowing transaction history
  - **When:** Circulation history API is called
  - **Then:** Returns ordered transaction history with member information

- **Integration Test**: `book-copy-detail.test.ts::should handle large circulation history performance`
  - **Given:** Book copy with extensive borrowing history (100+ transactions)
  - **When:** History is fetched and rendered
  - **Then:** Performance remains acceptable (< 2 seconds)

- **E2E Test**: `book-management.spec.ts::should view circulation history`
  - **Given:** User on book copy detail page
  - **When:** User views circulation history section
  - **Then:** Historical transactions are displayed chronologically

#### AC6: Delete/remove book copies functionality with confirmation dialog and audit trail

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `delete-book-copy-dialog.test.tsx::should show confirmation dialog`
  - **Given:** User triggers book copy deletion
  - **When:** Delete confirmation dialog appears
  - **Then:** Warning message and confirmation buttons are displayed

- **Integration Test**: `book-copy-detail.test.ts::should soft delete with audit trail`
  - **Given:** Valid book copy deletion request
  - **When:** Soft delete API is called
  - **Then:** is_deleted=true, deleted_at timestamp, deleted_by staff ID are set

- **Integration Test**: `book-copy-detail.test.ts::should prevent delete with active borrows`
  - **Given:** Book copy currently checked out to member
  - **When:** Delete operation is attempted
  - **Then:** Operation is blocked with warning about active transaction

- **E2E Test**: `book-management.spec.ts::should complete delete workflow`
  - **Given:** User with librarian+ role on book detail page
  - **When:** User initiates delete, confirms in dialog
  - **Then:** Book copy is soft deleted and user is redirected to books list

#### AC7: Role restrictions - all library staff can view but only librarian+ can edit

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `book-copy-detail.test.tsx::should show edit button only for librarian+ roles`
  - **Given:** User roles (volunteer vs librarian/manager/owner)
  - **When:** BookCopyDetail component renders based on permissions
  - **Then:** Edit/Delete buttons visible only for authorized roles

- **Integration Test**: `book-copy-detail.test.ts::should enforce API authorization`
  - **Given:** API requests from users with different roles
  - **When:** Edit/Delete operations are attempted
  - **Then:** Unauthorized users receive 403 Forbidden responses

- **Integration Test**: `book-copy-detail.test.ts::should validate RLS policies`
  - **Given:** Database queries from different user sessions
  - **When:** Row Level Security policies are applied
  - **Then:** Users can only access book copies from their assigned libraries

- **E2E Test**: `book-management.spec.ts::should enforce role-based access workflows`
  - **Given:** Users with different library roles
  - **When:** Users access book detail pages
  - **Then:** UI elements and available actions match role permissions

### Cross-Cutting Concerns Coverage

#### Error Handling

**Coverage: PARTIAL**

- **Integration Test**: `book-copy-detail.test.ts::should handle non-existent book copy`
  - **Given:** Invalid book copy ID
  - **When:** Book copy detail is requested
  - **Then:** 404 error is returned with appropriate message

- **Integration Test**: `book-copy-detail.test.ts::should handle network failures gracefully`
  - **Given:** Network connectivity issues during API calls
  - **When:** Requests fail due to network problems
  - **Then:** User-friendly error messages displayed, retry options available

**Gap:** Limited coverage of concurrent edit scenarios

#### Performance & Scalability

**Coverage: PARTIAL**

- **Integration Test**: `book-copy-detail.test.ts::should handle large circulation history efficiently`
  - **Given:** Book copies with extensive transaction histories
  - **When:** Details are loaded and displayed
  - **Then:** Performance remains within acceptable bounds

**Gap:** No load testing for concurrent user scenarios

### Critical Gaps

1. **Library Layout Validation (AC3)**
   - **Gap:** No validation against actual library shelf/location structure
   - **Risk:** Medium - Users can enter invalid location data
   - **Action:** Implement location dropdown with library-specific options

2. **Concurrent Edit Handling**
   - **Gap:** No testing for simultaneous edits by multiple users
   - **Risk:** Medium - Potential data conflicts in multi-user environment
   - **Action:** Add optimistic locking tests and conflict resolution

3. **Performance Under Load**
   - **Gap:** No load testing for multiple concurrent users accessing book details
   - **Risk:** Low - Current user base unlikely to cause issues
   - **Action:** Consider performance tests for future scaling

### Test Design Recommendations

Based on traceability analysis:

1. **Additional Integration Tests Needed:**
   - Library location validation against actual shelf data
   - Concurrent edit conflict resolution
   - Database constraint violation handling

2. **Enhanced Error Testing:**
   - Network timeout scenarios
   - Database connection failures
   - Invalid permission escalation attempts

3. **Performance Testing:**
   - Large dataset handling (1000+ book copies)
   - Concurrent user editing scenarios
   - Mobile device performance validation

### Risk Assessment

#### High Risk (0 requirements)
None identified - all critical paths have test coverage

#### Medium Risk (2 requirements)
- **AC3 Location Management:** Missing validation against library layout
- **Cross-cutting Concurrent Access:** Limited multi-user scenario testing

#### Low Risk (5 requirements)
- **AC1, AC2, AC4, AC5, AC6, AC7:** Full coverage across multiple test levels

### Recommendations for Implementation

1. **Priority 1 (Before Dev Starts):**
   - Implement library location validation lookup
   - Add comprehensive role-based access tests

2. **Priority 2 (During Development):**
   - Add concurrent edit handling and tests
   - Implement comprehensive error boundary testing

3. **Priority 3 (Before Production):**
   - Performance testing with realistic data volumes
   - Full regression testing suite execution

## Gate YAML Block Reference

```yaml
trace:
  totals:
    requirements: 7
    full: 5
    partial: 2
    none: 0
  planning_ref: "docs/qa/assessments/2.3-test-design-20250908.md"
  uncovered:
    - ac: "AC3"
      reason: "Missing library layout validation testing"
  notes: "See docs/qa/assessments/2.3-trace-20250908.md"
```

## Hook Line for Review Task

```text
Trace matrix: docs/qa/assessments/2.3-trace-20250908.md
```