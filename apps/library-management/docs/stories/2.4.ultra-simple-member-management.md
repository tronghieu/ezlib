# Story 2.4: Ultra-Simple Member Management

<!-- Powered by BMAD‚Ñ¢ Core -->

## Status
Ready for Review

## Story

**As a** library staff member,  
**I want** to register new library members with basic contact information,  
**so that** I can track who can borrow books without complex member management workflows.

## Acceptance Criteria

1. Simple member registration form: name, email, basic personal information, membership info with invitation system
2. Manual input member ID or automatic member ID generation (simple auto-increment format)
3. Basic member search by member ID, name or email only
4. Simple member list showing member ID, status, name, email, membership information added date and current checkout count
5. Basic member details showing personal information, membership information, and list of currently checked-out books
6. Edit member personal information with email format validation
7. Edit member membership information with status update
8. All members default to "active" status - no complex status management initially
9. Duplicate detection by email address to prevent multiple accounts
10. No advanced features like fines, limits, or communication preferences in initial version
11. Mobile-responsive design for all created UI
12. Restrict only allowing librarian+ role for member management

## Tasks / Subtasks

**üìù EXECUTION ORDER**: Tasks must be completed sequentially (1‚Üí2‚Üí3‚Üí4‚Üí5‚Üí6‚Üí7) due to component dependencies

### **Task 1: Create Member List Page Route and Layout** (AC: 3, 4, 8, 11, 12) ‚úÖ COMPLETED
*Covers: Member list display, basic search, status management, mobile design, role restrictions*
- [x] Create typescript types include json fields structures
- [x] Create `src/app/[library-code]/members/page.tsx` following Next.js 15 App Router patterns
- [x] Create `src/components/members/members-table.tsx` for members list table
- [x] Implement library context integration for scoped member operations
- [x] Add responsive layout with mobile-first design using Tailwind CSS
- [x] Create member list display with member ID, status, name, email, membership information, added date, and current checkout count
- [x] Implement basic search functionality by member ID, name, and email with real-time filtering
- [x] Add pagination for member lists (support up to 1,000 members per Epic 2 requirements)
- [x] Include "Add New Member" button prominently displayed for easy access
- [x] Add link to member list page on sidebar

### **Task 2: Build Member Registration Form Component** (AC: 1, 2, 8, 9, 12) ‚úÖ COMPLETED
*Covers: Registration form, member ID options, duplicate detection, role restrictions*
- [x] Create `src/app/[library-code]/members/add/page.tsx` following Next.js 15 App Router patterns  
- [x] Create `src/components/members/add-member-form.tsx` with comprehensive form validation`
- [x] Implement member registration form with name, email, basic personal information, and membership info fields
- [x] Add member ID input option with toggle between manual input or automatic generation
- [x] Implement automatic member ID generation (simple auto-increment format per library) as default
- [x] Implement duplicate detection by email address with clear error messaging
- [x] Add form validation with Zod schema for member registration
- [x] Set all new members to "active" status by default
- [x] Invitation system: add member invitation automatically
- [x] Include success notification with option to "Add Another Member"

### **Task 3: Build Member Profile Display Component** (AC: 5, 8) ‚úÖ COMPLETED
*Covers: Member profile view, checkout history, membership information display*
- [x] Create `src/app/[library-code]/members/[id]/page.tsx` following Next.js 15 App Router patterns
- [x] Create `src/components/members/member-profile.tsx` with comprehensive display
- [x] Implement member profile showing personal information, membership information, and member ID
- [x] If member has pending invitation, display it
- [x] Add list of currently checked-out books with book titles and checkout dates
- [x] Create member status display with visual indicators for active/inactive states
- [x] Display membership information including type, added date, and status
- [x] Add breadcrumb navigation integration with existing member list page
- [x] Implement 404 error page for non-existent members

### **Task 4: Build Member Edit Form Component** (AC: 6, 7, 8, 9, 12) ‚úÖ COMPLETED
*Covers: Personal information editing, membership info editing, email validation, role restrictions*
- [x] Create `src/app/[library-code]/members/[id]/edit/page.tsx` following Next.js 15 App Router patterns
- [x] Create `src/components/members/edit-member-form.tsx` with field validation
- [x] Implement editable personal information fields: name, email, phone, address
- [x] Add membership information editing: type, status, and notes
- [x] Add email format validation with proper error messaging
- [x] Implement duplicate email detection during edit operations
- [x] Add form validation with Zod schema for member updates
- [x] Include member status management (active/inactive/banned states)
- [x] Add role validation for edit operations (librarian+ only)

### **Task 5: Implement Database Integration APIs** (AC: 1-11) ‚úÖ COMPLETED
*Covers: Member queries, creation, updates, search functionality, membership info*
- [x] Create member API functions in `src/lib/api/members.ts` with full CRUD operations
- [x] Create invitation API functions in `src/lib/api/invitations.ts` with full CRUD operations
- [x] Implement member registration API with manual/automatic member ID generation options
- [x] Create member search API with member ID, name, and email filtering capabilities
- [x] Add member profile API with joined checkout information and membership details
- [x] Implement member update APIs for both personal information and membership information
- [x] Add duplicate email checking API for registration and updates
- [x] Integrate invitation system APIs for member registration workflow
- [x] Ensure proper RLS policies and library context isolation
- [x] Add error handling for database operations and constraint violations

### **Task 6: Implement Real-time Integration and State Management** (AC: 4, 5) ‚úÖ COMPLETED
*Covers: TanStack Query integration, cache management, real-time updates*
- [x] Create member hooks in `src/lib/hooks/use-members.ts` with TanStack Query integration
- [x] Implement member list query with search and pagination capabilities
- [x] Add member profile query with real-time checkout count updates
- [x] Create member mutation hooks for add, edit, and status updates
- [x] Implement query invalidation patterns for immediate UI updates
- [x] Add optimistic updates for member operations where appropriate
- [x] Include loading states and error handling for all member operations

### **Task 7: Testing Implementation** (AC: 1-12) ‚úÖ COMPLETED
*Covers: Complete functionality validation, form validation, database operations, role restrictions*
- [x] Run lint check and fix errors for files created or edited
- [x] Create unit tests for member validation schemas
- [x] Add integration tests for member API functions and database operations
- [x] Write E2E tests for complete add ‚Üí view ‚Üí edit member workflow
- [x] Test duplicate email detection for both registration and edit operations
- [x] Validate member search functionality with various search terms
- [x] Test role-based access control for member management operations

## Dev Notes

### **Previous Story Context**

Based on completed Story 2.3 (Book Details and Management), we have established:

- Library context management system with RLS policies working effectively
- TanStack Query integration patterns for data fetching and mutations with proper cache invalidation
- React Hook Form with Zod validation schemas for form handling and validation
- Role-based access control patterns with permission system integration
- Mobile-responsive design with shadcn/ui components and Tailwind CSS
- Comprehensive error handling and loading state patterns
- Real-time updates and query invalidation strategies

### **Data Models and Database Schema**

[Source: docs/architecture/database-design.md, docs/architecture/database-views-and-functions.md]

**Library Members - Core Data Structure:**

The member management system uses the `public.library_members` table with the following schema:

```typescript
// Member Core Data - library_members table
interface LibraryMember {
  id: string;                    // Primary key UUID
  user_id?: string;              // Optional reference to auth.users(id), NULL for non-digital members
  library_id: string;            // References libraries(id)
  member_id: string;             // Library-specific identifier (e.g., "M001", "CARD-12345")
  personal_info: {               // JSONB: Contact and personal details
    first_name: string;
    last_name: string;
    email: string;
    phone?: string;
    address?: {
      street?: string;
      city?: string;
      state?: string;
      country?: string;
      postal_code?: string;
    };
  };
  membership_info: {             // JSONB: Membership details
    type: 'regular' | 'student' | 'senior';
    fees_owed: number;
    expiry_date?: string;
    notes?: string;
  };
  borrowing_stats: {             // JSONB: Cached borrowing statistics for performance
    current_loans: number;
    total_books_borrowed: number;
    overdue_items: number;
    total_late_fees: number;
  };
  status: 'active' | 'inactive' | 'banned';
  is_deleted: boolean;
  deleted_at?: string;
  deleted_by?: string;
  created_at: string;
  updated_at: string;
}
```

The invitation system uses the `public.invitations` table with the following schema:

```typescript
// Invitation Data Structure - invitations table
interface Invitation {
  id: string;                    // Primary key UUID (auto-generated)
  library_id: string;            // References libraries(id) 
  inviter_id: string;            // References auth.users(id) - who sent the invitation
  email: string;                 // Invitee's email address (required)
  role: string;                  // Intended role: 'volunteer', 'librarian', etc.
  invitation_type: string;       // Type: 'library_member', 'library_staff'
  status: string;                // Status: 'pending' (default), 'accepted', 'expired', 'rejected'
  token: string;                 // Unique invitation token (auto-generated, no dashes)
  expires_at: string;            // Expiration timestamp (default: 7 days from creation)
  personal_message?: string;     // Optional personal message from inviter
  metadata: {                    // JSONB: Additional invitation context
    invited_by_name?: string;    // Name of person who sent invitation
    invitation_reason?: string;   // Reason for invitation
    [key: string]: any;          // Extensible for future needs
  };
  created_at: string;            // Auto-timestamp
  updated_at: string;            // Auto-timestamp with update trigger
}
```

**Invitation Types and Usage:**
- `library_member` - For inviting library patrons to join as members
- `library_staff` - For inviting staff members (librarians, volunteers, etc.)

**Common Role Values:**
- `volunteer` - Library volunteer member
- `librarian` - Staff librarian role  
- `manager` - Library manager role
- `owner` - Library owner role

**Invitation Workflow Integration:**
```typescript
// Create invitation for new member registration
const createMemberInvitation = async (
  libraryId: string,
  inviterUserId: string,
  email: string,
  personalMessage?: string
): Promise<Invitation> => {
  return await supabase
    .from("invitations")
    .insert({
      library_id: libraryId,
      inviter_id: inviterUserId,
      email,
      invitation_type: "library_member",
      personal_message: personalMessage,
      metadata: {
        invited_by_name: inviterName,
        invitation_reason: "New member registration"
      }
    })
    .select()
    .single();
};

// Check for existing invitation during member registration
const findPendingInvitation = async (
  email: string, 
  libraryId: string
): Promise<Invitation | null> => {
  const { data } = await supabase
    .from("invitations")
    .select("*")
    .eq("email", email)
    .eq("library_id", libraryId)
    .eq("invitation_type", "library_member")
    .eq("status", "pending")
    .gt("expires_at", new Date().toISOString())
    .single();

  return data;
};
```


**Member ID Generation Pattern:**

```typescript
// Automatic member ID generation (simple auto-increment format)
const generateMemberID = async (libraryId: string): Promise<string> => {
  const { count } = await supabase
    .from("library_members")
    .select("id", { count: "exact", head: true })
    .eq("library_id", libraryId)
    .eq("is_deleted", false);
  
  const nextNumber = (count || 0) + 1;
  return `M${nextNumber.toString().padStart(3, '0')}`; // M001, M002, etc.
};
```

**Member Search and List Query Pattern:**

```typescript
// Member list with search and checkout count (updated to include member ID search)
const fetchMembers = async (libraryId: string, searchTerm?: string) => {
  let query = supabase
    .from("library_members")
    .select(`
      id,
      member_id,
      personal_info,
      membership_info,
      borrowing_stats,
      status,
      created_at,
      updated_at
    `)
    .eq("library_id", libraryId)
    .eq("is_deleted", false)
    .order("created_at", { ascending: false });

  if (searchTerm) {
    query = query.or(`
      member_id.ilike.%${searchTerm}%,
      personal_info->>first_name.ilike.%${searchTerm}%,
      personal_info->>last_name.ilike.%${searchTerm}%,
      personal_info->>email.ilike.%${searchTerm}%
    `);
  }

  return query;
};
```

**Duplicate Email Detection Pattern:**

```typescript
// Check for duplicate email within library
const checkDuplicateEmail = async (
  libraryId: string, 
  email: string, 
  excludeMemberId?: string
): Promise<boolean> => {
  let query = supabase
    .from("library_members")
    .select("id")
    .eq("library_id", libraryId)
    .eq("personal_info->>email", email)
    .eq("is_deleted", false);

  if (excludeMemberId) {
    query = query.neq("id", excludeMemberId);
  }

  const { data } = await query.single();
  return !!data;
};
```

### **Component Architecture Patterns**

[Source: docs/architecture/tech-stack.md, docs/architecture/coding-standards.md]

**Required Tech Stack for Member Management:**

- **React Hook Form 7.62.0** with form state management for all member forms
- **Zod 4.1.3** for member data validation schemas and email format validation
- **TanStack Query 5.85.5** for data fetching, caching, and mutation operations
- **shadcn/ui Components** for consistent UI design (Card, Button, Input, Select, Dialog)
- **Lucide React 0.542.0** for user profile, edit, search, and status icons

**Member Component Architecture Pattern:**

```typescript
// src/components/members/member-profile.tsx
import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";

interface MemberProfileProps {
  memberId: string;
  libraryId: string;
  canEdit: boolean;
}

export function MemberProfile({ memberId, libraryId, canEdit }: MemberProfileProps) {
  const { data: member, isLoading } = useQuery({
    queryKey: ["member-profile", memberId, libraryId],
    queryFn: () => fetchMemberProfile(memberId, libraryId),
  });

  const { data: checkouts } = useQuery({
    queryKey: ["member-checkouts", memberId, libraryId],
    queryFn: () => fetchMemberActiveCheckouts(memberId, libraryId),
  });

  // Profile display with conditional edit interface
}

// src/components/members/add-member-form.tsx
interface AddMemberFormProps {
  libraryId: string;
  onSuccess: (member: LibraryMember) => void;
}

export function AddMemberForm({ libraryId, onSuccess }: AddMemberFormProps) {
  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm<MemberRegistrationData>({
    resolver: zodResolver(memberRegistrationSchema),
  });

  const mutation = useMutation({
    mutationFn: (data: MemberRegistrationData) => createMember(data, libraryId),
    onSuccess: (newMember) => {
      queryClient.invalidateQueries({ queryKey: ["members", libraryId] });
      onSuccess(newMember);
    },
  });

  // Form implementation with validation and duplicate checking
}
```

### **File Locations and Project Structure**

[Source: docs/architecture/source-tree.md]

**New Files to Create:**

- `src/types/members.d.ts` - Member type definitions
- `src/types/invitation.d.ts` - Invitation type definitions
- `src/app/[library-code]/members/page.tsx` - Member list page route with search
- `src/app/[library-code]/members/add/page.tsx` - Member registration page route
- `src/app/[library-code]/members/[id]/page.tsx` - Member profile page route  
- `src/app/[library-code]/members/[id]/edit/page.tsx` - Member edit page route
- `src/components/members/members-table.tsx` - Member list display component
- `src/components/members/member-profile.tsx` - Member profile display component
- `src/components/members/add-member-form.tsx` - Member registration form
- `src/components/members/edit-member-form.tsx` - Member edit form
- `src/components/members/member-search.tsx` - Search functionality component
- `src/lib/api/members.ts` - Member API functions and database operations
- `src/lib/hooks/use-members.ts` - Member data fetching and mutation hooks
- `src/lib/validation/members.ts` - Member validation schemas with Zod

**Import Path Pattern (MANDATORY):**

```typescript
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select } from "@/components/ui/select";
import { useMemberProfile } from "@/lib/hooks/use-members";
import { usePermissions } from "@/lib/hooks/use-permissions";
import { memberRegistrationSchema } from "@/lib/validation/members";
import type { LibraryMember } from "@/lib/types/members";
```

### **Role-Based Access Control Implementation**

[Source: docs/architecture/data-access-rules.md]

**Access Control Rules for Library Members:**

- **READ**: Owner, manager, librarian roles for the library (volunteers cannot read - AC 12)
- **EDIT**: Owner, manager, librarian roles for the library (volunteers cannot edit)
- **CREATE**: Owner, manager, librarian roles for the library (volunteers cannot create)
- **DELETE**: Soft delete only via EDIT permissions (owner, manager, librarian)

**Permission Check Implementation:**

```typescript
// Use existing library context for permission validation
const { library, staff } = useLibraryContext();
const { canManageMembers } = usePermissions();

// Role-based UI rendering
{canManageMembers() && (
  <Button asChild>
    <Link href={`/${library.code}/members/add`}>Add New Member</Link>
  </Button>
)}

// API permission enforcement
const canEditMember = hasMinimumRoleLevel('librarian');
if (!canEditMember) {
  throw new Error('Insufficient permissions to edit members');
}
```

### **Form Validation Schema**

```typescript
// src/lib/validation/members.ts
import { z } from "zod";

export const memberRegistrationSchema = z.object({
  member_id: z
    .string()
    .max(20, "Member ID must be less than 20 characters")
    .optional(), // Optional for automatic generation
  first_name: z
    .string()
    .min(1, "First name is required")
    .max(50, "First name must be less than 50 characters"),
  last_name: z
    .string()
    .min(1, "Last name is required")
    .max(50, "Last name must be less than 50 characters"),
  email: z
    .string()
    .email("Please enter a valid email address")
    .max(100, "Email must be less than 100 characters"),
  phone: z
    .string()
    .regex(/^[\+]?[1-9][\d]{0,15}$/, "Please enter a valid phone number")
    .optional()
    .or(z.literal("")),
  address: z.object({
    street: z
      .string()
      .max(100, "Street address must be less than 100 characters")
      .optional(),
    city: z
      .string()
      .max(50, "City must be less than 50 characters")
      .optional(),
    state: z
      .string()
      .max(50, "State must be less than 50 characters")
      .optional(),
    country: z
      .string()
      .max(50, "Country must be less than 50 characters")
      .optional(),
    postal_code: z
      .string()
      .max(20, "Postal code must be less than 20 characters")
      .optional(),
  }).optional(),
  membership_type: z.enum(["regular", "student", "senior"]).default("regular"),
  membership_notes: z
    .string()
    .max(500, "Membership notes must be less than 500 characters")
    .optional(),
});

export const memberUpdateSchema = memberRegistrationSchema.partial();
export type MemberRegistrationData = z.infer<typeof memberRegistrationSchema>;
export type MemberUpdateData = z.infer<typeof memberUpdateSchema>;
```

### **Library Context and RLS Integration**

[Source: Story 2.3 completion notes, library context patterns]

**Library-Scoped Operations:**

- All member operations must include `library_id` filter for RLS compliance
- Use existing library context from URL parameter `[library-code]`
- Permission validation scoped to current library only
- Member operations automatically include library association
- Staff permissions validated through existing authentication system

**Library Context Usage Pattern:**

```typescript
// In member management page components
export default function MembersPage({
  params,
}: {
  params: { "library-code": string };
}) {
  const { library, staff } = useLibraryContext();
  const { canManageMembers } = usePermissions();

  const { data: members } = useMembers(library.id);

  // Component implementation with library-scoped operations
}
```

### **Real-time Integration and Cache Management**

[Source: Story 2.3 patterns - TanStack Query integration]

**Query Invalidation Pattern:**

```typescript
// src/lib/hooks/use-members.ts
export function useMembers(libraryId: string, searchTerm?: string) {
  const queryClient = useQueryClient();

  const createMutation = useMutation({
    mutationFn: (data: MemberRegistrationData) => createMember(data, libraryId),
    onSuccess: (newMember) => {
      // Invalidate member list queries for immediate UI updates
      queryClient.invalidateQueries({ queryKey: ["members", libraryId] });
      queryClient.setQueryData(["member-profile", newMember.id], newMember);
      
      toast.success("Member registered successfully!");
    },
    onError: (error) => {
      toast.error(`Failed to register member: ${error.message}`);
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ memberId, data }: { memberId: string; data: MemberUpdateData }) => 
      updateMember(memberId, data, libraryId),
    onSuccess: (updatedMember) => {
      queryClient.invalidateQueries({ queryKey: ["members", libraryId] });
      queryClient.setQueryData(["member-profile", updatedMember.id], updatedMember);
      
      toast.success("Member updated successfully!");
    },
  });

  return { createMutation, updateMutation };
}
```

### **Testing Standards**

[Source: docs/architecture/coding-standards.md]

**Testing Framework:** Jest for unit tests, React Testing Library for component tests, Playwright for E2E tests

**Test File Locations:**

- Hook tests: `src/lib/hooks/__tests__/use-members.test.ts`
- API tests: `src/lib/api/__tests__/members.test.ts`, `src/lib/api/__tests__/invitations.test.ts`
- Validation tests: `src/lib/validation/__tests__/members.test.ts`
- E2E tests: `tests/e2e/member-management.spec.ts`

**Required Test Cases:**

1. **Member Registration Tests**: Test form validation, duplicate email detection, automatic ID generation and invitation system functionality
2. **Member List Tests**: Test search functionality, pagination, and display of member information
3. **Member Profile Tests**: Test profile display, checkout information, and edit access controls
4. **Edit Form Tests**: Test field updates, email validation, and permission enforcement
5. **API Integration Tests**: Test member CRUD operations, RLS compliance, and error handling
6. **Library Context Tests**: Ensure operations are properly scoped to active library
7. **Real-time Update Tests**: Verify cache invalidation and UI refresh after member operations
8. **Mobile Responsiveness Tests**: Validate member management usability on different screen sizes

**Test Examples:**

```typescript
// Component test example
describe("AddMemberForm", () => {
  it("should register new member with valid information", async () => {
    const mockOnSuccess = jest.fn();
    render(<AddMemberForm libraryId="lib-123" onSuccess={mockOnSuccess} />);

    await user.type(screen.getByLabelText(/first name/i), 'John');
    await user.type(screen.getByLabelText(/last name/i), 'Doe');
    await user.type(screen.getByLabelText(/email/i), 'john.doe@example.com');
    await user.click(screen.getByRole('button', { name: /register member/i }));

    expect(mockOnSuccess).toHaveBeenCalledWith(
      expect.objectContaining({
        member_id: expect.stringMatching(/^M\d{3}$/),
        personal_info: {
          first_name: 'John',
          last_name: 'Doe',
          email: 'john.doe@example.com',
        },
        status: 'active',
      })
    );
  });

  it("should detect duplicate email addresses", async () => {
    render(<AddMemberForm libraryId="lib-123" onSuccess={jest.fn()} />);

    await user.type(screen.getByLabelText(/email/i), 'existing@example.com');
    await user.click(screen.getByRole('button', { name: /register member/i }));

    expect(screen.getByText(/email address already exists/i)).toBeInTheDocument();
  });

  it("should validate required fields", async () => {
    render(<AddMemberForm libraryId="lib-123" onSuccess={jest.fn()} />);

    await user.click(screen.getByRole('button', { name: /register member/i }));

    expect(screen.getByText(/first name is required/i)).toBeInTheDocument();
    expect(screen.getByText(/last name is required/i)).toBeInTheDocument();
    expect(screen.getByText(/please enter a valid email address/i)).toBeInTheDocument();
  });
});
```

## Change Log

| Date       | Version | Description                                                                 | Author     |
| ---------- | ------- | --------------------------------------------------------------------------- | ---------- |
| 2025-01-08 | 1.0     | Initial story creation with full context from Epic 2.4 requirements         | Bob (SM)    |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 - Full Stack Developer Agent (James)

### Debug Log References  
- Task 1, 5, 6 Implementation: Member list page, table component, API functions, hooks, validation schemas, and type definitions created
- Type compatibility issues resolved with Supabase Json types
- ESLint errors fixed for TypeScript strict mode compliance
- Task 7 Implementation (2025-01-10): Merged test files, comprehensive API tests, E2E test suite created

### Completion Notes List
**All Tasks Completed:**
- ‚úÖ Task 1: Member List Page Route and Layout 
- ‚úÖ Task 2: Member Registration Form Component
- ‚úÖ Task 3: Member Profile Display Component
- ‚úÖ Task 4: Member Edit Form Component  
- ‚úÖ Task 5: Database Integration APIs
- ‚úÖ Task 6: Real-time Integration and State Management
- ‚úÖ Task 7: Testing Implementation - All tests completed including unit, integration, and E2E tests

**QA Fixes Applied (2025-01-09):**
- ‚úÖ Created comprehensive hook tests for TanStack Query integration (`use-members.test.tsx`)
- ‚úÖ Added complete validation schema tests for Zod edge cases and form validation (`members.test.ts`)
- ‚úÖ Implemented full API test suite for member CRUD operations and library context isolation (`members.test.ts`)
- ‚úÖ Added invitation API tests for workflow integration, token generation, and security (`invitations.test.ts`)
- ‚úÖ Addressed QA assessment gaps: hook testing, validation testing, API data structure validation, and permission boundary testing
- ‚úÖ Enhanced test coverage from partial to full for AC3 (search functionality), AC4 (list display), and AC12 (role restrictions)

**Final Testing Implementation (2025-01-10):**
- ‚úÖ Merged members-simplified.test.ts into members.test.ts for comprehensive API testing
- ‚úÖ Fixed mock structure for improved test reliability and maintainability
- ‚úÖ Created comprehensive E2E test suite in tests/e2e/member-management.spec.ts
- ‚úÖ Tests cover all acceptance criteria including registration, search, profile view, edit, duplicate detection, and role-based access
- ‚úÖ Added mobile responsiveness tests and concurrent operation tests
- ‚úÖ All lint checks pass without errors for member test files

### File List
**Test Files:**
- `src/lib/api/__tests__/members.test.ts` - Comprehensive API integration tests (merged with simplified tests)
- `src/lib/api/__tests__/invitations.test.ts` - Invitation system API tests
- `src/lib/hooks/__tests__/use-members.test.tsx` - TanStack Query hook tests
- `src/lib/validation/__tests__/members.test.ts` - Zod validation schema tests
- `tests/e2e/member-management.spec.ts` - Complete E2E test suite for member workflow

**Created Files:**
- `src/types/members.d.ts` - Complete member type definitions with Json compatibility
- `src/types/invitations.d.ts` - Invitation type definitions 
- `src/app/[library-code]/members/page.tsx` - Member list page route with permissions and library context
- `src/app/[library-code]/members/add/page.tsx` - Member registration page with role validation and user profile integration
- `src/app/[library-code]/members/[id]/page.tsx` - Member profile page route with server-side authentication
- `src/app/[library-code]/members/[id]/edit/page.tsx` - Member edit page route with role-based permissions
- `src/components/members/members-table.tsx` - Full-featured member table with search, filtering, pagination
- `src/components/members/add-member-form.tsx` - Comprehensive registration form with manual/auto ID toggle and invitation system
- `src/components/members/member-profile.tsx` - Member profile component with personal info, checkout history, membership details
- `src/components/members/edit-member-form.tsx` - Member edit form with validation, status management, and delete functionality
- `src/lib/api/members.ts` - Complete member API functions (CRUD operations, duplicate detection, member ID generation)
- `src/lib/api/invitations.ts` - Complete invitation system API functions (CRUD operations, member invitation workflow)
- `src/lib/hooks/use-members.ts` - Member management hooks with TanStack Query integration and invitation system
- `src/lib/validation/members.ts` - Member validation schemas with Zod (updated with status field for edit operations)
- `src/lib/utils/validators.ts` - Reusable validation utilities for email, phone, etc.

**Modified Files:**
- `src/components/ui/alert-dialog.tsx` - Added alert dialog component via shadcn
