# Story 1.4: Library Context Management

## Status

**HIGH PRIORITY - ENABLES MULTI-TENANT OPERATIONS** - Depends on Story 1.2 and 1.3 completion

## Story

**As a** library administrator,  
**I want** to select which library I'm currently managing,  
**so that** all subsequent operations are scoped to the correct library context and data isolation is maintained.

## Prerequisites

- ✅ **Story 1.2**: Database integration must be complete for library data access
- ✅ **Story 1.3**: Authentication must be working for user library access validation

## Acceptance Criteria

### **AC1: Library Context Provider Implementation**
1. React Context provider created for managing current library selection
2. Context state includes current library, available libraries, loading states, and errors
3. Context provider wraps entire application to make library context globally available
4. Library selection persistence implemented using localStorage for user convenience
5. Context updates trigger re-renders only for components that consume library context

### **AC2: Library Access Validation**
1. User's library access retrieved from database using authenticated user ID
2. Only libraries where user has admin permissions are shown in selection
3. Library access validation integrated with role-based permission system
4. Library access refreshed when authentication state changes
5. Error handling for users with no library access permissions

### **AC3: Library Selection Interface**
1. Library selector component created with dropdown/combobox interface
2. Selector shows library name, code, and user's role for each accessible library
3. Single library auto-selection when user has access to only one library
4. Search functionality for users with access to many libraries
5. Loading and empty states properly handled in selector interface

### **AC4: Context Persistence and Restoration**
1. Selected library persisted to localStorage with user-specific key
2. Library selection restored on page refresh and app initialization
3. Invalid library selections (removed access) handled gracefully
4. Default library selection logic for new users or cleared storage
5. Context persistence works across browser sessions and tabs

### **AC5: Library-Scoped Data Operations**
1. All database queries automatically filtered by selected library ID
2. Custom hooks created for library-aware data fetching
3. Data operations prevented when no library is selected
4. Library context passed to all relevant components and services
5. Real-time subscriptions scoped to selected library for performance

### **AC6: Multi-Tenant UI Integration**
1. Current library displayed prominently in application header/navigation
2. Library switcher accessible from main navigation for multi-library admins
3. Breadcrumb navigation includes library context throughout application
4. Loading states during library switching handled smoothly
5. UI clearly indicates when operations are scoped to specific library

## Implementation Tasks

### **Task 1: Create Library Context Provider** (AC1)
- [ ] Implement React Context with TypeScript for library state management
- [ ] Create provider component with state management for current and available libraries
- [ ] Implement context hook for consuming library context in components
- [ ] Add proper error boundaries and loading state management
- [ ] Test context provider with various library access scenarios

### **Task 2: Implement Library Access Validation** (AC2)
- [ ] Create hooks to fetch user's library access from database
- [ ] Integrate library access with authentication state changes
- [ ] Implement role-based library access filtering
- [ ] Add error handling for no-access scenarios
- [ ] Test library access validation with different user permission levels

### **Task 3: Build Library Selection Interface** (AC3)
- [ ] Create library selector dropdown component using shadcn/ui components
- [ ] Implement search and filtering for large library lists
- [ ] Add auto-selection logic for single-library users
- [ ] Create loading and empty state components
- [ ] Style selector according to design system standards

### **Task 4: Implement Context Persistence** (AC4)
- [ ] Add localStorage integration for library selection persistence
- [ ] Implement restoration logic for page refreshes and app initialization
- [ ] Handle invalid library selections and access changes
- [ ] Create default library selection logic
- [ ] Test persistence across browser sessions and scenarios

### **Task 5: Create Library-Scoped Data Operations** (AC5)
- [ ] Implement custom hooks for library-aware database operations
- [ ] Add automatic library ID filtering to all relevant database queries
- [ ] Create library context validation for data operations
- [ ] Implement library-scoped real-time subscriptions
- [ ] Test data operations with library context switching

### **Task 6: Integrate Multi-Tenant UI Elements** (AC6)
- [ ] Add library display to application header/navigation
- [ ] Implement library switcher in main navigation
- [ ] Create breadcrumb components with library context
- [ ] Add loading states for library switching operations
- [ ] Test UI updates when library context changes

## Definition of Done

### **Technical Validation**
- [ ] Library context provider properly manages state for all consuming components
- [ ] Library selection persists across browser refreshes and sessions
- [ ] Database operations properly filtered by selected library ID
- [ ] Library switching updates all active queries and subscriptions
- [ ] Context state changes only trigger re-renders for relevant components

### **User Experience Validation**
- [ ] Library selection interface intuitive and responsive
- [ ] Current library context clearly visible throughout application
- [ ] Library switching provides immediate feedback and updates
- [ ] Loading states prevent user confusion during context operations
- [ ] Error scenarios (no access, network failures) handled gracefully

### **Security and Data Isolation**
- [ ] Users can only select libraries where they have admin permissions
- [ ] Database queries properly scoped to prevent cross-library data access
- [ ] Library context validation prevents unauthorized operations
- [ ] Role-based permissions integrated with library selection
- [ ] Multi-tenant data isolation maintained at all levels

### **Performance Requirements**
- [ ] Library context changes efficiently update dependent components
- [ ] Database subscriptions properly scoped to selected library
- [ ] Library switching completes within 1 second for good user experience
- [ ] Memory usage optimized for users with access to many libraries
- [ ] Context provider doesn't cause unnecessary re-renders

## Epic Dependencies Resolved

### **Enables Epic 1 Continuation:**
- ✅ **Story 1.5**: Dashboard requires library context for data display

### **Enables All Epic 2 Stories:**
- ✅ **Story 2.1**: Book lists filtered by selected library
- ✅ **Story 2.2**: New books added to selected library
- ✅ **Story 2.4**: Member management scoped to selected library
- ✅ **Story 2.5**: Circulation operations context-aware
- ✅ **Story 2.6**: Search results filtered by library context

### **Provides Foundation For:**
- Multi-tenant data operations
- Library-scoped real-time updates
- Role-based UI behavior
- Audit logging with library context
- Performance-optimized database queries

## Dev Notes

### **Multi-Tenant Architecture Considerations**
- **Data Isolation**: Every database query must include library_id filter
- **Performance**: Library context should not cause excessive re-renders
- **Security**: Library access must be validated on both client and server
- **User Experience**: Context switching should feel instantaneous
- **Scalability**: System should handle users with access to 50+ libraries

### **Integration with Existing Systems**
- **Authentication**: Library access tied to user's authenticated session
- **Database**: Leverages existing library_staff table for access control
- **Real-time**: Subscriptions must be library-scoped for performance
- **Permissions**: Role within library determines available operations

### **Critical Implementation Details**
- Use React Context rather than global state to avoid prop drilling
- Implement proper TypeScript typing for library context values
- Handle edge cases: network failures, permission changes, deleted libraries
- Optimize for common case: users typically have access to 1-3 libraries
- Prepare for future enhancement: cross-library operations and reporting

### **Testing Strategy**
- **Unit Tests**: Context provider state management and utility functions
- **Integration Tests**: Library switching with database operations
- **Permission Tests**: Access control and role-based library filtering
- **Performance Tests**: Context provider efficiency with many consumers
- **User Experience Tests**: Library switching workflows and error scenarios

## Change Log

| Date       | Version | Description                                            | Author     |
| ---------- | ------- | ------------------------------------------------------ | ---------- |
| 2025-08-28 | 2.0     | Complete rewrite with implementation-ready requirements | Sarah (PO) |
| 2025-08-26 | 1.0     | Initial story creation from Epic 1.4 requirements     | Sarah (PO) |

## QA Validation Checklist

### **Context Management Testing**
- [ ] Library context provider manages state correctly across components
- [ ] Context updates properly trigger component re-renders
- [ ] Library selection persists across browser refreshes
- [ ] Context restoration works after app reinitialization
- [ ] Memory leaks prevented with proper cleanup

### **Access Control Testing**
- [ ] Users can only see libraries where they have admin access
- [ ] Library access updates when user permissions change
- [ ] Invalid library selections handled gracefully
- [ ] Role information correctly displayed for each library
- [ ] No access state handled with appropriate user guidance

### **UI Integration Testing**
- [ ] Library selector displays and functions correctly
- [ ] Current library clearly indicated throughout application
- [ ] Library switching provides immediate visual feedback
- [ ] Loading states prevent confusion during operations
- [ ] Search functionality works for users with many libraries

### **Data Isolation Testing**
- [ ] Database queries filtered by selected library ID
- [ ] Library context prevents cross-library data access
- [ ] Real-time subscriptions properly scoped to library
- [ ] Library switching updates all dependent queries
- [ ] Data operations blocked when no library selected

### **Performance Testing**
- [ ] Library context changes complete within acceptable time limits
- [ ] Context provider doesn't cause excessive component re-renders
- [ ] Memory usage reasonable for users with access to many libraries
- [ ] Library switching responsive even with large datasets
- [ ] Context provider scales well with growing user base