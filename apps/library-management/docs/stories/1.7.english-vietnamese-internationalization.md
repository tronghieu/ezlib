# Story 1.7: English/Vietnamese Internationalization Support

<!-- Powered by BMAD™ Core -->

## Status
Draft

## Story

**As a** library administrator in a diverse community,  
**I want** the library management system to support both English and Vietnamese languages with seamless switching,  
**so that** our library staff can use the system in their preferred language with appropriate cultural formatting and the interface remains professional and accessible to Vietnamese-speaking staff.

## Acceptance Criteria

### **AC1: next-intl Package Integration and Configuration**

1. next-intl package installed and properly configured with Next.js 15 App Router
2. Cookie-based locale management implemented (no URL routing prefixes)
3. Configuration files created for English ('en') and Vietnamese ('vi') locales
4. TypeScript integration with generated types for translation keys
5. Next.js configuration updated to support internationalization plugin

### **AC2: Translation Infrastructure and Message Structure**

1. Complete English and Vietnamese translation files created for all existing UI elements
2. Message structure organized by feature areas (navigation, dashboard, inventory, members, circulation, auth, errors)
3. TypeScript type safety implemented for translation keys and interpolation
4. Translation validation system to ensure consistency between locales
5. Support for message interpolation and pluralization where needed

### **AC3: Language Switching Component and User Interface**

1. Language switcher component created with dropdown interface showing "English" and "Tiếng Việt"
2. Language preference persisted via secure HTTP cookies with 1-year expiration
3. API endpoint implemented for language switching (/api/locale)
4. Smooth language switching without URL changes or page reload
5. Loading states and user feedback during language changes

### **AC4: Localized Form Validation and Error Handling**

1. All form validation messages translated for both languages
2. Zod schemas updated to support localized validation errors
3. Error boundary components display localized error messages
4. Loading skeleton components show localized "loading" text
5. Toast notifications and user feedback messages fully localized

### **AC5: Regional Formatting and Cultural Adaptation**

1. Date formatting appropriate for each locale (English vs Vietnamese formats)
2. Number formatting with proper thousand separators and decimal notation
3. Vietnamese timezone support (Asia/Ho_Chi_Minh) vs UTC for English
4. Currency formatting (USD for English, VND for Vietnamese)
5. Cultural UI adaptations for Vietnamese text length and reading patterns

### **AC6: Database Integration and User Preference Storage**

1. User locale preference storage in database profiles table
2. Automatic language selection based on user's saved preference on login
3. Fallback to cookie preference when user is not authenticated
4. Integration with Supabase authentication to retrieve user language preference
5. Database migration to add preferred_language column to profiles

## Tasks / Subtasks

### **Task 1: Install and Configure next-intl Framework** (AC1)
- [ ] Install next-intl package and TypeScript dependencies
- [ ] Create i18n configuration files (config.ts, request.ts)
- [ ] Update next.config.ts with next-intl plugin integration
- [ ] Create locale cookie management utilities
- [ ] Set up TypeScript types for internationalization

### **Task 2: Create Translation Message Infrastructure** (AC2)
- [ ] Create comprehensive English translation file (en.json) with all UI strings
- [ ] Create comprehensive Vietnamese translation file (vi.json) with professional translations
- [ ] Implement TypeScript type generation and validation for translation keys
- [ ] Create message index file with type exports and global type augmentation
- [ ] Add translation consistency validation tests

### **Task 3: Implement Language Switching System** (AC3)
- [ ] Create LanguageSwitcher component with dropdown interface
- [ ] Implement /api/locale API route for language preference changes
- [ ] Add language preference persistence via secure cookies
- [ ] Create smooth transition system using React's useTransition
- [ ] Add loading states and success/error feedback for language changes

### **Task 4: Localize Forms and Error Handling** (AC4)
- [ ] Update all existing form components to use localized validation
- [ ] Create localized Zod schema factory functions
- [ ] Update error boundary components with translated messages
- [ ] Localize loading skeleton and state components
- [ ] Update toast notification system with translation support

### **Task 5: Implement Regional Formatting** (AC5)
- [ ] Create library-specific formatter utilities for dates and numbers
- [ ] Configure timezone and currency formatting for each locale
- [ ] Update date/time display components throughout the application
- [ ] Implement Vietnamese-specific UI spacing and typography considerations
- [ ] Add cultural formatting for member IDs, ISBNs, and library-specific data

### **Task 6: Database Integration and User Preferences** (AC6)
- [ ] Create database migration for user language preferences
- [ ] Implement user preference storage and retrieval functions
- [ ] Update authentication system to include language preference loading
- [ ] Create automatic language selection on login based on user preference
- [ ] Add preference update functionality when users change language

### **Task 7: Comprehensive Testing and Validation** (All ACs)
- [ ] Create unit tests for translation consistency and completeness
- [ ] Implement integration tests for language switching functionality
- [ ] Add E2E tests for complete internationalization user flows
- [ ] Create performance tests to ensure i18n doesn't impact loading times
- [ ] Validate accessibility compliance for both languages

## Dev Notes

### **Previous Story Context**

Based on completed Story 1.3 (Cross-Domain Passwordless Authentication), we have:
- Established authentication system with user sessions
- User profile storage in database
- Authentication context and hooks available for user state management
- Permission system ready for role-based access

### **Technical Architecture** 
[Source: docs/i18n-implementation-plan.md]

**Selected Approach**: Cookie-based internationalization without URL routing
- No `/en/` or `/vi/` prefixes in URLs
- Language preference stored in cookies and database
- Uses next-intl v4+ with Next.js 15 App Router
- Full TypeScript integration with generated types

**Project Structure:**
```
src/
├── i18n/
│   ├── config.ts               # Locale configuration
│   ├── request.ts              # Server-side i18n setup  
│   └── locale.ts               # Locale utilities
├── messages/
│   ├── en.json                 # English translations
│   ├── vi.json                 # Vietnamese translations
│   └── index.ts                # Type exports
├── app/
│   ├── layout.tsx              # Root layout with i18n provider
│   └── api/locale/route.ts     # Language switching API
└── lib/
    └── locale-cookie.ts        # Cookie management
```

### **Key Technical Details**
[Source: docs/architecture/tech-stack.md]

**Framework Integration:**
- Next.js 15.5.2 with App Router architecture
- TypeScript 5+ with strict mode enabled
- Supabase client integration for user preferences
- shadcn/ui components with translation support

**Component Pattern:**
```typescript
// Standard translation usage pattern
import { useTranslations } from 'next-intl';

function Component() {
  const t = useTranslations('namespace');
  return <h1>{t('title')}</h1>;
}
```

**Database Integration:**
[Source: docs/i18n-implementation-plan.md#database-integration]

Database Schema Addition:
```sql
ALTER TABLE profiles 
ADD COLUMN preferred_language VARCHAR(5) DEFAULT 'en';
```

**Performance Considerations:**
- Translation caching with 1-hour cache duration
- Lazy loading for large translation bundles  
- Bundle optimization to prevent size bloat
- Server-side rendering compatibility maintained

### **Security Requirements**
[Source: docs/architecture/coding-standards.md]

- Secure cookie configuration with SameSite protection
- Locale validation to prevent injection attacks
- Input sanitization for all translation parameters
- User preference validation before database storage

### **Error Handling Strategy**

- Graceful fallback to default locale (English) for missing translations
- User-friendly error messages in current locale
- Translation loading failure handling
- Cookie persistence error recovery

### **Integration Points**

**Authentication System:**
- Leverage existing `useAuth` hook for user context
- Use established user profile storage pattern
- Integration with existing permission system

**Component System:**
- Update existing shadcn/ui component usage
- Maintain established styling and design patterns
- Preserve accessibility standards across languages

**Testing**

### **Testing Standards**
[Source: docs/architecture/tech-stack.md#testing]

**Testing Framework:** Vitest for unit tests, Playwright for E2E
**Test File Locations:** `src/__tests__/` for unit tests, `tests/e2e/` for E2E tests
**Coverage Requirements:** Maintain existing coverage standards

**i18n-Specific Tests Required:**
1. **Translation Consistency Tests**: Verify matching keys between en.json and vi.json
2. **Component Integration Tests**: Ensure all components render correctly in both languages  
3. **Language Switching Tests**: Validate smooth transitions and state persistence
4. **Form Validation Tests**: Check localized error messages work correctly
5. **Performance Tests**: Verify i18n doesn't impact loading times
6. **E2E Flow Tests**: Complete user flows in both languages

**Test Examples:**
```typescript
// Translation consistency test
describe('Translation consistency', () => {
  it('should have matching keys in all locales', () => {
    const enKeys = getAllKeys(en);
    const viKeys = getAllKeys(vi);
    expect(viKeys).toEqual(enKeys);
  });
});

// Component localization test  
describe('LanguageSwitcher', () => {
  it('should switch locale and refresh page', () => {
    // Test implementation
  });
});
```

### **File Creation Guidelines**
[Source: docs/architecture/source-tree.md]

All new files should follow established patterns:
- React components in `src/components/` with proper TypeScript typing
- Utility functions in `src/lib/` with comprehensive error handling
- API routes in `src/app/api/` following Next.js 15 conventions
- Tests co-located with source files or in appropriate test directories

### **Code Quality Standards**

- Maintain TypeScript strict mode compliance
- Follow established ESLint and Prettier configurations  
- Use existing component patterns and design system
- Implement comprehensive error handling for all i18n operations
- Performance optimization for translation loading and switching

## Change Log

| Date       | Version | Description                                          | Author        |
| ---------- | ------- | ---------------------------------------------------- | ------------- |
| 2025-08-29 | 1.0     | Initial story creation for i18n implementation      | Bob (SM)      |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be recorded by dev agent*

### Debug Log References  
*To be recorded by dev agent*

### Completion Notes
*To be recorded by dev agent*

### File List
*To be recorded by dev agent*

## QA Results

*This section will be populated by the QA agent after implementation review*