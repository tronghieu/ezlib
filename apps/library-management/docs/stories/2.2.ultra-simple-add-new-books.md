# Story 2.2: Ultra-Simple Add New Books

<!-- Powered by BMAD™ Core -->

## Status

Approved

## Story

**As a** library staff member,  
**I want** to add new books with minimal required information,  
**so that** I can quickly build our book inventory without complex cataloging workflows.

## Acceptance Criteria

1. Simple add book form with only required fields: title, author, publisher, publication year, ISBN (optional)
2. Optional ISBN lookup integration with crawler service for metadata enrichment if crawler service is available
3. Manual entry fallback for books without ISBNs - title and author minimum required
4. Duplicate detection prevents adding books with same title/author combination
5. All new books automatically set to "available" status
6. Simple success notification with option to "Add Another Book"
7. Basic form validation ensures title and author are provided
8. Added books immediately appear in book list with available status
9. No complex cataloging fields (genre, publisher, etc.) in initial version

## Tasks / Subtasks

### **Task 1: Create Add Book Page Route and Layout** (AC: 1, 7, 8, 9)

- [ ] Create `src/app/[library-code]/books/add/page.tsx` following Next.js 15 App Router patterns
- [ ] Implement library context integration for scoped book creation
- [ ] Add responsive layout with mobile-first design using Tailwind CSS
- [ ] Set up proper TypeScript interfaces for component props and form data
- [ ] Add navigation breadcrumb integration with existing books page

### **Task 2: Build Add Book Form Component** (AC: 1, 3, 7, 9)

- [ ] Create `src/components/books/add-book-form.tsx` using React Hook Form + Zod validation
- [ ] Implement form fields: title (required), author (required), publisher (optional), publication year (optional), ISBN (optional)
- [ ] Add proper form validation with Zod schema and error messaging
- [ ] Implement responsive form layout with shadcn/ui form components
- [ ] Add loading states and form submission feedback with proper TypeScript typing

### **Task 3: Implement Database Integration for Book Creation** (AC: 4, 5, 8)

- [ ] Create book creation logic in `src/lib/api/books.ts` with proper error handling
- [ ] Implement duplicate detection query checking title/author combination within library scope
- [ ] Write functions to create `general_books`, `book_editions`, and `book_copies` records with proper relationships
- [ ] Set automatic "available" status for new book copies with library_id scoping
- [ ] Add RLS-compliant queries ensuring library context isolation

### **Task 4: Add Optional ISBN Lookup Integration** (AC: 2)

- [ ] Create ISBN validation utility function in `src/lib/validation/isbn.ts`
- [ ] Add conditional crawler service integration check and API endpoint call
- [ ] Implement metadata enrichment fallback with graceful degradation if service unavailable
- [ ] Add loading states for ISBN lookup with user feedback
- [ ] Store enrichment status and source information in book records

### **Task 5: Implement Success States and Navigation** (AC: 6, 8)

- [ ] Add success notification using Sonner toast with "Add Another Book" option
- [ ] Implement form reset functionality for adding multiple books sequentially
- [ ] Add navigation back to book list with proper query invalidation for immediate display
- [ ] Create success state component with next action options
- [ ] Integrate with TanStack Query to invalidate books list cache

### **Task 6: Testing Implementation**

- [ ] Create unit tests for add book form component validation and submission
- [ ] Add integration tests for book creation API with duplicate detection
- [ ] Write E2E tests for complete add book workflow including ISBN lookup
- [ ] Test mobile responsiveness and accessibility compliance
- [ ] Validate form error handling and edge cases (network failures, validation errors)

## Dev Notes

### **Previous Story Context**

Based on completed Story 2.1 (Ultra-Simple Book List Interface), we have:

- Complete book list interface with search, sorting, and pagination
- Established database query patterns for complex book data retrieval
- Real-time subscription system for book status updates
- Library context system with RLS policies for data isolation
- Comprehensive error handling and loading state patterns
- Mobile-responsive design with shadcn/ui components

### **Data Models and Database Schema**

[Source: src/lib/types/database.ts]

**Book Creation Flow - Three-Table Pattern:**

1. **`general_books`**: Create canonical book record
   - Key fields: `canonical_title`, `first_publication_year`, `subjects`
   - Relationships: None (top-level book entity)

2. **`book_editions`**: Create specific edition record
   - Key fields: `general_book_id`, `title`, `isbn_10`, `isbn_13`, `language`
   - Relationships: Links to `general_books` via `general_book_id`

3. **`book_copies`**: Create physical copy for library
   - Key fields: `book_edition_id`, `library_id`, `availability`, `condition_info`, `copy_number`
   - Relationships: Links to `book_editions` and `libraries`

**Author Association Pattern:**

```typescript
// book_contributors table for author relationships
const authorLink = {
  author_id: string, // Links to authors table
  general_book_id: string, // Links to general_books
  book_edition_id: string, // Optional: Links to specific edition
  role: "author" | "editor" | "translator",
  sort_order: number, // Author ordering
  credit_text: string, // "John Doe" or "Edited by Jane Smith"
};
```

**Book Creation Query Pattern:**

```typescript
// 1. Create or find author
const { data: author } = await supabase
  .from("authors")
  .upsert({
    name: authorName,
    canonical_name: normalizeAuthorName(authorName),
  })
  .select("id")
  .single();

// 2. Create general book
const { data: generalBook } = await supabase
  .from("general_books")
  .insert({
    canonical_title: title,
    first_publication_year: publicationYear,
  })
  .select("id")
  .single();

// 3. Create book edition
const { data: edition } = await supabase
  .from("book_editions")
  .insert({
    general_book_id: generalBook.id,
    title: title,
    isbn_10: isbn10,
    isbn_13: isbn13,
    language: "en",
  })
  .select("id")
  .single();

// 4. Link author to book
await supabase.from("book_contributors").insert({
  author_id: author.id,
  general_book_id: generalBook.id,
  book_edition_id: edition.id,
  role: "author",
  sort_order: 1,
});

// 5. Create physical copy for library
const { data: bookCopy } = await supabase.from("book_copies").insert({
  book_edition_id: edition.id,
  library_id: libraryId,
  copy_number: generateCopyNumber(),
  availability: { status: "available", since: new Date().toISOString() },
  condition_info: { condition: "new", notes: null },
});
```

### **Component Architecture Patterns**

[Source: docs/architecture/tech-stack.md, docs/architecture/coding-standards.md]

**Required Tech Stack for Forms:**

- **React Hook Form 7.62.0** with proper TypeScript integration
- **Zod 4.1.3** for schema validation and type inference
- **@hookform/resolvers 5.2.1** for Zod integration
- **shadcn/ui Form Components** built on Radix UI primitives
- **TanStack Query 5.85.5** for server state management
- **Sonner 2.0.7** for success notifications and feedback

**Add Book Form Component Pattern:**

```typescript
// src/components/books/add-book-form.tsx
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";

const addBookSchema = z.object({
  title: z.string().min(1, "Title is required").max(255),
  author: z.string().min(1, "Author is required").max(255),
  publisher: z.string().max(255).optional(),
  publication_year: z
    .number()
    .min(1000)
    .max(new Date().getFullYear())
    .optional(),
  isbn: z
    .string()
    .regex(/^[\d-]{10,17}$/, "Invalid ISBN format")
    .optional(),
});

type AddBookFormData = z.infer<typeof addBookSchema>;

interface AddBookFormProps {
  onSubmit: (data: AddBookFormData) => Promise<void>;
  onCancel: () => void;
  isLoading: boolean;
}

export function AddBookForm({
  onSubmit,
  onCancel,
  isLoading,
}: AddBookFormProps): JSX.Element {
  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
  } = useForm<AddBookFormData>({
    resolver: zodResolver(addBookSchema),
  });

  // Implementation with proper error handling and loading states
}
```

**Form Validation Schema:**

```typescript
// src/lib/validation/books.ts
import { z } from "zod";

export const addBookSchema = z.object({
  title: z
    .string()
    .min(1, "Title is required")
    .max(255, "Title must be less than 255 characters")
    .trim(),
  author: z
    .string()
    .min(1, "Author is required")
    .max(255, "Author name must be less than 255 characters")
    .trim(),
  publisher: z
    .string()
    .max(255, "Publisher name must be less than 255 characters")
    .optional(),
  publication_year: z.coerce
    .number()
    .min(1000, "Year must be after 1000")
    .max(new Date().getFullYear(), "Year cannot be in the future")
    .optional(),
  isbn: z
    .string()
    .regex(/^(?:\d{9}[\dXx]|\d{13})$/, "Invalid ISBN format")
    .optional()
    .or(z.literal("")),
});

export type AddBookFormData = z.infer<typeof addBookSchema>;
```

### **File Locations and Project Structure**

[Source: docs/architecture/source-tree.md]

**New Files to Create:**

- `src/app/[library-code]/books/add/page.tsx` - Add book page component
- `src/components/books/add-book-form.tsx` - Main add book form component
- `src/lib/api/books.ts` - Book CRUD operations and API utilities
- `src/lib/validation/books.ts` - Zod schemas for book validation
- `src/lib/validation/isbn.ts` - ISBN validation and formatting utilities
- `src/lib/hooks/use-add-book.ts` - Custom hook for book creation logic
- `src/components/ui/form-field.tsx` - Reusable form field wrapper component

**Import Path Pattern (MANDATORY):**

```typescript
import { Button } from "@/components/ui/button";
import {
  Form,
  FormField,
  FormItem,
  FormLabel,
  FormControl,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { useAddBook } from "@/lib/hooks/use-add-book";
import { addBookSchema } from "@/lib/validation/books";
import type { Database } from "@/lib/types/database";
```

### **ISBN Integration and Crawler Service**

[Source: Technical assumptions from CLAUDE.md - EzLib crawler service]

**Crawler Service Integration:**

- **Service Endpoint**: Check if crawler service is available at configured endpoint
- **ISBN Lookup Flow**: Submit ISBN → receive enriched metadata → populate form fields
- **Graceful Degradation**: If service unavailable, allow manual entry without errors
- **Metadata Fields**: Title, author, publisher, publication year, description, cover image URL
- **Enrichment Status**: Track enrichment attempts and success/failure in database

**ISBN Validation and Processing:**

```typescript
// src/lib/validation/isbn.ts
export function validateISBN(isbn: string): boolean {
  const cleanISBN = isbn.replace(/[-\s]/g, "");

  if (cleanISBN.length === 10) {
    return validateISBN10(cleanISBN);
  } else if (cleanISBN.length === 13) {
    return validateISBN13(cleanISBN);
  }

  return false;
}

export function formatISBN(isbn: string): { isbn10?: string; isbn13?: string } {
  // Implementation for ISBN format conversion
}

export async function enrichFromISBN(
  isbn: string
): Promise<BookMetadata | null> {
  // Optional crawler service integration
}
```

### **Library Context and RLS Integration**

[Source: Story 1.7 completion notes, library context patterns]

**Library-Scoped Operations:**

- All book creation must include `library_id` filter for RLS compliance
- Use existing library context from URL parameter `[library-code]`
- Duplicate detection scoped to current library only
- Book copies automatically associated with current library
- Staff permissions validated through existing authentication system

**Library Context Usage Pattern:**

```typescript
// In add book page component
export default function AddBookPage({
  params,
}: {
  params: { "library-code": string };
}) {
  const { library } = useLibraryContext();

  const addBookMutation = useAddBook(library.id);

  // Component implementation
}
```

### **Duplicate Detection Strategy**

[Source: AC 4 - prevent same title/author combinations]

**Duplicate Detection Query:**

```typescript
// Check for existing books with same title/author in current library
const duplicateQuery = supabase
  .from("book_copies")
  .select(
    `
    id,
    book_editions!inner (
      title,
      general_books!inner (
        canonical_title,
        book_contributors!inner (
          authors!inner (canonical_name)
        )
      )
    )
  `
  )
  .eq("library_id", libraryId)
  .ilike("book_editions.title", title)
  .ilike(
    "book_editions.general_books.book_contributors.authors.canonical_name",
    normalizeAuthorName(author)
  );
```

**Duplicate Resolution UX:**

- Show warning dialog with existing book details
- Allow user to confirm addition as new copy or cancel
- Option to navigate to existing book details
- Clear messaging about why duplicate was detected

### **Real-time Integration and Cache Management**

[Source: Story 2.1 patterns - TanStack Query integration]

**Query Invalidation Pattern:**

```typescript
// src/lib/hooks/use-add-book.ts
export function useAddBook(libraryId: string) {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (bookData: AddBookFormData) => createBook(bookData, libraryId),
    onSuccess: () => {
      // Invalidate books list to show new book immediately
      queryClient.invalidateQueries({ queryKey: ["books", libraryId] });

      // Show success notification
      toast.success("Book added successfully!", {
        action: {
          label: "Add Another",
          onClick: () => router.push(`/${libraryCode}/books/add`),
        },
      });
    },
    onError: (error) => {
      toast.error(`Failed to add book: ${error.message}`);
    },
  });
}
```

### **Styling and Design Standards**

[Source: docs/architecture/tech-stack.md#ui--styling]

**Required Form Components:**

- **shadcn/ui Form** components for consistent form styling and validation
- **Tailwind CSS** utility classes for responsive design
- **Lucide React** icons for form feedback and actions
- **Radix UI** primitives for accessibility compliance

**Form Layout Specification:**

- Two-column layout on desktop, single column on mobile
- Required field indicators with proper ARIA labels
- Loading states with skeleton placeholders
- Error states with clear error messaging
- Success states with next action guidance

### **Testing Requirements**

[Source: docs/architecture/tech-stack.md, docs/architecture/coding-standards.md]

**Testing Framework:** Vitest for unit tests, Playwright for E2E
**Test File Locations:**

- Unit tests: `src/components/books/__tests__/add-book-form.test.tsx`
- Integration tests: `src/lib/hooks/__tests__/use-add-book.test.ts`
- API tests: `src/lib/api/__tests__/books.test.ts`
- E2E tests: `tests/e2e/add-book-workflow.spec.ts`

**Required Test Cases:**

1. **Form Validation Tests**: Test required field validation, ISBN format validation, character limits
2. **Duplicate Detection Tests**: Verify duplicate prevention logic and user feedback
3. **Book Creation Tests**: Test complete book creation flow with all relationships
4. **ISBN Lookup Tests**: Test crawler service integration with fallback handling
5. **Error Handling Tests**: Network failures, validation errors, database constraints
6. **Real-time Update Tests**: Verify book appears in list immediately after creation
7. **Library Context Tests**: Ensure books are created with proper library association
8. **Mobile Responsiveness Tests**: Validate form usability on different screen sizes

**Test Examples:**

```typescript
// Component test example
describe("AddBookForm", () => {
  it("should validate required fields", async () => {
    render(<AddBookForm onSubmit={mockOnSubmit} onCancel={mockOnCancel} isLoading={false} />);

    const submitButton = screen.getByRole('button', { name: /add book/i });
    await user.click(submitButton);

    expect(screen.getByText('Title is required')).toBeInTheDocument();
    expect(screen.getByText('Author is required')).toBeInTheDocument();
  });

  it("should call onSubmit with valid data", async () => {
    render(<AddBookForm onSubmit={mockOnSubmit} onCancel={mockOnCancel} isLoading={false} />);

    await user.type(screen.getByLabelText(/title/i), 'Test Book');
    await user.type(screen.getByLabelText(/author/i), 'Test Author');
    await user.click(screen.getByRole('button', { name: /add book/i }));

    expect(mockOnSubmit).toHaveBeenCalledWith({
      title: 'Test Book',
      author: 'Test Author',
      publisher: undefined,
      publication_year: undefined,
      isbn: undefined
    });
  });
});

// API test example
describe("Book Creation API", () => {
  it("should create book with all relationships", async () => {
    const bookData = {
      title: 'Test Book',
      author: 'Test Author',
      publisher: 'Test Publisher',
      publication_year: 2024
    };

    const result = await createBook(bookData, 'library-123');

    expect(result).toHaveProperty('generalBook.id');
    expect(result).toHaveProperty('edition.id');
    expect(result).toHaveProperty('copy.id');
    expect(result.copy.library_id).toBe('library-123');
    expect(result.copy.availability.status).toBe('available');
  });

  it("should detect duplicates within library scope", async () => {
    // Create first book
    await createBook({ title: 'Duplicate Test', author: 'Same Author' }, 'library-123');

    // Attempt to create duplicate
    await expect(
      createBook({ title: 'Duplicate Test', author: 'Same Author' }, 'library-123')
    ).rejects.toThrow('Book with same title and author already exists in this library');
  });
});
```

## Testing

### **Testing Standards**

[Source: docs/architecture/tech-stack.md, docs/architecture/coding-standards.md]

**Testing Framework:** Vitest for unit tests, Playwright for E2E
**Test File Locations:**

- Unit tests: `src/components/books/__tests__/add-book-form.test.tsx`
- Integration tests: `src/lib/hooks/__tests__/use-add-book.test.ts`
- E2E tests: `tests/e2e/add-book-workflow.spec.ts`

**Coverage Requirements:** Maintain existing coverage standards for new components

**Required Test Scenarios:**

1. **Form Validation Workflow**: Test all validation rules with proper error messaging
2. **Book Creation Workflow**: End-to-end book creation with database verification
3. **Duplicate Detection Workflow**: Prevent duplicate books and show appropriate warnings
4. **ISBN Lookup Integration**: Test crawler service integration with fallback scenarios
5. **Library Context Integration**: Ensure proper library scoping and RLS compliance
6. **Real-time Updates**: Verify new books appear immediately in book list
7. **Mobile Responsiveness**: Test form usability across different screen sizes
8. **Error Handling**: Network failures, validation errors, and edge cases

## Change Log

| Date       | Version | Description                              | Author   |
| ---------- | ------- | ---------------------------------------- | -------- |
| 2025-09-02 | 1.0     | Initial story creation with full context | Bob (SM) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

_To be filled during implementation_

### Completion Notes

_To be filled during implementation_

### File List

_To be filled during implementation_
