# Story 1.3: Core Enrichment Service Logic

## Status
Draft

## Story
**As a** development team
**I want** to implement the core enrichment service that orchestrates metadata collection and validation
**So that** we can process book enrichment requests with data quality assurance and conflict resolution

## Acceptance Criteria
1. Enrichment service orchestrates the complete workflow from ISBN input to validated book metadata
2. Service validates and normalizes input data with comprehensive error handling
3. Multiple data sources are merged with conflict resolution rules (OpenLibrary primary, fallbacks handled)
4. Data quality scoring identifies incomplete or suspicious metadata for manual review
5. Enrichment status tracking provides detailed progress and error information
6. Service handles concurrent enrichment requests efficiently with proper resource management

## Tasks / Subtasks
- [ ] Task 1: Implement Core Enrichment Orchestration (AC: 1, 5)
  - [ ] Create enrichment_service.py with main EnrichmentService class
  - [ ] Implement single book enrichment workflow with status tracking
  - [ ] Add enrichment job management with unique correlation IDs
  - [ ] Integrate with OpenLibrary client for primary data source
  - [ ] Add comprehensive error handling and logging throughout workflow
- [ ] Task 2: Input Validation and Normalization (AC: 2)
  - [ ] Create validation_service.py for data quality assessment
  - [ ] Implement ISBN validation and normalization pipeline
  - [ ] Add input sanitization for text fields (titles, authors, descriptions)
  - [ ] Create validation rules for publication dates, publisher names
  - [ ] Add data completeness scoring algorithm
- [ ] Task 3: Data Quality and Conflict Resolution (AC: 3, 4)
  - [ ] Implement metadata merging logic with source priority rules
  - [ ] Add conflict detection for disagreeing data sources
  - [ ] Create data quality scoring based on completeness and consistency
  - [ ] Add suspicious data detection (impossible dates, malformed text)
  - [ ] Implement flagging system for manual review requirements
- [ ] Task 4: External API Service Coordinator (AC: 1, 6)
  - [ ] Create external_api_service.py to manage multiple API clients
  - [ ] Implement parallel API calls with timeout and error handling
  - [ ] Add response caching with TTL management
  - [ ] Create fallback chain when primary sources fail
  - [ ] Add API performance metrics and health monitoring
- [ ] Task 5: Enrichment Models and Status Tracking (AC: 1, 5)
  - [ ] Create database/enrichment_job.py for job state management
  - [ ] Implement enrichment status enum (PENDING, IN_PROGRESS, SUCCESS, FAILED, PARTIAL)
  - [ ] Add detailed error tracking and categorization
  - [ ] Create enrichment result models with quality scores
  - [ ] Add timestamp tracking for performance monitoring
- [ ] Task 6: Service Integration and API Layer (AC: 6)
  - [ ] Update api/enrichment.py to use new enrichment service
  - [ ] Add batch processing endpoint for multiple book enrichments
  - [ ] Implement proper async handling for concurrent requests
  - [ ] Add request queuing and rate limiting at service level
  - [ ] Create detailed API documentation with examples

## Dev Notes

### Previous Story Insights
From Stories 1.1-1.2:
- FastAPI foundation with async support established
- OpenLibrary client integration with rate limiting and retry logic
- Data models for external API responses and internal representation
- Test infrastructure with comprehensive coverage patterns

### Business Logic Requirements
[Source: docs/prd.md#Core Enrichment Features]
- **Primary Data Source**: OpenLibrary API provides authoritative book metadata
- **Data Validation**: ISBN normalization, date validation, text sanitization
- **Quality Assurance**: Completeness scoring, conflict detection, suspicious data flagging
- **Performance**: Complete enrichment within 10 seconds, support 100 concurrent requests

### Service Architecture Pattern
[Source: docs/architecture/source-tree.md#Services Layer]
```
services/
├── enrichment_service.py      # Main orchestration (this story)
├── external_api_service.py    # Multi-API coordination (this story)
├── validation_service.py      # Data quality validation (this story)
├── cache_service.py           # Caching layer (future story)
├── database_service.py        # Database operations (next story)
└── metrics_service.py         # Performance metrics (this story)
```

### Enrichment Workflow Design
[Source: docs/prd.md#Data Flow]
1. **Input Validation**: Normalize ISBN, validate format
2. **Cache Check**: Look for recent enrichment results
3. **External Data Fetch**: Call OpenLibrary API (with fallbacks in future)
4. **Data Validation**: Quality scoring and suspicious data detection
5. **Conflict Resolution**: Merge data from multiple sources
6. **Result Storage**: Persist enriched metadata to database
7. **Status Update**: Update job status and return results

### Data Quality Requirements
[Source: docs/prd.md#NFR13-16]
- **Completeness Target**: 95% metadata completeness for valid ISBNs
- **Date Validation**: Publication dates between 1500 and current year
- **Text Sanitization**: Remove HTML tags, normalize whitespace, validate encoding
- **Duplicate Detection**: Author name normalization to prevent duplicates

### Configuration Requirements
[Source: docs/architecture/tech-stack.md#Configuration Management]
```python
# Additional environment variables:
ENRICHMENT_TIMEOUT=10           # seconds per book
ENRICHMENT_CACHE_TTL=86400     # 24 hours
ENRICHMENT_MAX_CONCURRENT=100   # concurrent requests
ENRICHMENT_MIN_QUALITY_SCORE=60 # minimum acceptable quality
```

### Error Categorization Strategy
[Source: docs/architecture/source-tree.md#Core Functionality]
```python
class EnrichmentError(Exception):
    """Base enrichment error"""

class ValidationError(EnrichmentError):
    """Input validation failed"""

class DataSourceError(EnrichmentError):
    """External API failure"""

class QualityError(EnrichmentError):
    """Data quality below threshold"""

class ConcurrencyError(EnrichmentError):
    """Resource exhaustion"""
```

### Metrics Collection Requirements
[Source: docs/prd.md#Success Metrics]
- Enrichment success rate (>95% target)
- Average enrichment time (<10 seconds)
- Data completeness percentage
- External API response times
- Cache hit rates
- Concurrent request handling capacity

### Testing Strategy
[Source: docs/architecture/tech-stack.md#Development & Testing]
- Mock external API responses for unit tests
- Test enrichment workflow with various ISBN types
- Validate data quality scoring algorithm
- Test concurrent request handling with asyncio
- Integration tests with real but rate-limited API calls
- Performance tests for timeout and throughput requirements

## Testing
### Test Requirements
[Source: docs/architecture/tech-stack.md#Development & Testing]
- Comprehensive service layer testing in tests/services/
- Test complete enrichment workflow end-to-end
- Mock external dependencies (OpenLibrary client, database, cache)
- Validate error handling and recovery scenarios
- Test concurrent request processing with async patterns
- Performance testing for timeout compliance

### Test Scenarios
**Successful Enrichment**:
- Valid ISBN-13 with complete OpenLibrary response
- ISBN-10 conversion to ISBN-13 normalization
- Data quality scoring above minimum threshold

**Error Handling**:
- Invalid ISBN format validation
- OpenLibrary API timeout/failure scenarios
- Low data quality score handling
- Concurrent request limit exceeded

**Edge Cases**:
- Books without covers or publication dates
- Authors with multiple name formats
- Very old books (pre-1900) with unusual publication data
- Non-English books with special characters

### Performance Requirements
- Single enrichment completes within 10 seconds
- Service handles 100 concurrent requests
- Memory usage remains stable under load
- Graceful degradation when external APIs are slow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for core enrichment logic | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
Reference to debug logs will be added during implementation.

### Completion Notes List
*To be populated during development*

### File List
*To be populated with created/modified files during implementation*

## QA Results
*This section will be populated by the QA agent during review*
